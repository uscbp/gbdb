{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
    <title>GBDB - View Behavioral {% if object.parent %}Sub-{% endif %}Event</title>
    <link href="{% static 'gbdb/scripts/video-js/video-js.css' %}" rel="stylesheet">
    <script src="{% static 'gbdb/scripts/video-js/video.js' %}"></script>
    <script src="{% static 'gbdb/scripts/video-js/video-framebyframe.js' %}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script type="text/javascript">

        {% if ispopup %}
            opener.addBehavioralEvent({{ object.id }}, {% if object.start_time %}'{{ object.start_time.hour }}:{{ object.start_time.minute }}:{{ object.start_time.second }}.{{ object.start_time.microsecond }}'{% else %}''{% endif %}, {% if object.duration %}'{{ object.duration.hour }}:{{ object.duration.minute }}:{{ object.duration.second }}.{{ object.duration.microsecond }}'{% else %}''{% endif %},{{ object.start_time_seconds }},{{ object.end_time_seconds }},'/videos/behavioral_event/{{ object.id }}.mp4', '{% for primate in object.primates.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ primate }}{% endfor %}', '{% for context in object.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}', '{% for ethogram in object.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}', '{{ object.notes }}');
            self.close();
        {% endif %}

        function deleteBehavioralEvent()
        {
            if(confirm('This will delete this Behavioral Event as well as all links to it from other entries. Do you really want to delete the current Behavioral Event?'))
            {
                var data={'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={type:"POST", url:"/gbdb/behavioral_event/{{ object.id }}/delete/", data: data, complete: doneDelete };
                $.ajax(args);
            }
        }

        function doneDelete()
        {
            {% if not object.parent %}
                document.location.href='/gbdb/observation_session/{{ object.observation_session.id }}/';
            {% else %}
                document.location.href='/gbdb/behavioral_event/{{ object.parent.id }}/';
            {% endif %}
        }

        function initialize() {
            var map = new google.maps.Map(
                    document.getElementById('map-canvas'), {
                        center: new google.maps.LatLng({{ object.observation_session.location.latitude }}, {{ object.observation_session.location.longitude }}),
                        zoom: 13,
                        mapTypeId: google.maps.MapTypeId.HYBRID
                    });

            var marker = new google.maps.Marker({
                position: new google.maps.LatLng({{ object.observation_session.location.latitude }}, {{ object.observation_session.location.longitude }}),
                map: map,
                title: '{{ object.observation_session.location_name }}'
            });
        }

        function playClip(start_time, end_time)
        {
            videojs("behavioral_event_video").off("play",playBehavioralEventClip);
            videojs("behavioral_event_video").off("timeupdate",stopBehavioralEventClip);
            videojs("behavioral_event_video").currentTime(start_time);
            function stopClip(){
                if(this.currentTime()>=end_time)
                {
                    this.pause();
                    this.off('timeupdate',stopClip);
                    videojs("behavioral_event_video").on("play",playBehavioralEventClip);
                    videojs("behavioral_event_video").on("timeupdate",stopBehavioralEventClip);
                }
            }
            videojs("behavioral_event_video").on("timeupdate",stopClip);
            videojs("behavioral_event_video").play();
            return false;
        }

        function playBehavioralEventClip()
        {
            if(videojs("behavioral_event_video").currentTime()<{{ object.start_time_seconds }})
                videojs("behavioral_event_video").currentTime({{ object.start_time_seconds }});
        }

        function stopBehavioralEventClip()
        {
            if(videojs("behavioral_event_video").currentTime()>={{ object.end_time_seconds }})
                videojs("behavioral_event_video").pause();
        }

        $(document).ready(function()
        {
            videojs.options.flash.swf = "{{ site_url }}/static/gbdb/scripts/video-js/video-js.swf";
            {% if not object.video.name %}
                videojs("behavioral_event_video").on("loadedmetadata",function(){
                    this.on("timeupdate",stopBehavioralEventClip);
                    this.on("play",playBehavioralEventClip);
                });
            {% endif %}
            videojs('behavioral_event_video', {
                plugins: {
                    framebyframe: {
                        fps: 30,
                        steps: [
                            { text: '-5', step: -5 },
                            { text: '-1', step: -1 },
                            { text: '+1', step: 1 },
                            { text: '+5', step: 5 },
                        ]
                    }
                }
            });
        });
        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
{% endblock %}
{% block content %}
<div id="detail">
    <h2>Behavioral {% if object.parent %}Sub-{% endif %}Event</h2>
    <table class="tab_panel">
        <tr valign="top">
            <td>{% if object.parent %}<strong><a href="/gbdb/behavioral_event/{{ object.parent.id }}/">Parent behavioral event</a></strong>{% else %}<strong><a href="/gbdb/observation_session/{{ object.observation_session.id }}/">Observation session</a></strong>{% endif %}</td>
            <td rowspan="7">
                <video id="behavioral_event_video" class="video-js vjs-default-skin" controls preload="metadata"
                       width="525" height="350" data-setup='{}'>
                    <source src="{{ object.video_url_mp4 }}" type="video/mp4">
                    <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                </video>
            </td>
        </tr>
        {% if object.start_time %}
            <tr valign="top">
                <td><strong>Start time:</strong> {{ object.start_time.hour }}:{{ object.start_time.minute }}:{{ object.start_time.second }}.{{ object.start_time.microsecond }}</td>
            </tr>
            <tr valign="top">
                <td colspan="2"><strong>Relative to:</strong> {{ object.relative_to }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Duration:</strong> {{ object.duration.hour }}:{{ object.duration.minute }}:{{ object.duration.second }}.{{ object.duration.microsecond }}</td>
            </tr>
        {% endif %}
        <tr valign="top">
            <td colspan="2"><strong>Location:</strong> {{ object.observation_session.location_name }}</td>
        </tr>
        <tr valign="top">
            <td colspan="2">
                <div id="map-canvas" style="height:200px"></div>
            </td>
        </tr>
        <tr valign="top">
            <td colspan="2"><strong>Primates:</strong> {% for primate in object.primates.all %}{% if forloop.counter0 > 0%}, {% endif %}<a href="/gbdb/primate/{{ primate.id }}/">{{ primate }}</a>{% endfor %}</td>
        </tr>
        <tr valign="top">
            <td colspan="2"><strong>Contexts:</strong> {% for context in object.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
        </tr>
        <tr valign="top">
            <td colspan="2"><strong>Ethograms:</strong> {% for ethogram in object.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
        </tr>
        <tr valign="top">
            <td colspan="2"><strong>Notes:</strong> {{ object.notes }}</td>
        </tr>
    </table>
    {% if not object.parent %}
        <br>
        <h3>Behavioral Sub-Events</h3>
        <div id="sub_behavioral_events">
            {% for sub_behavioral_event in sub_behavioral_events %}
                <div id="sub_behavioral_event-{{ forloop.counter }}" name="sub_behavioral_event">
                    <table class="tab_panel">
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td width=30%><strong><a href="/gbdb/behavioral_event/{{ sub_behavioral_event.id }}/">Event {{ forloop.counter }}</a></strong></td>
                            <td rowspan="7">
                                {% if object.video_url_mp4 %}
                                    <a href="" onclick="return playClip({{ sub_behavioral_event.start_time_seconds }},{{ sub_behavioral_event.end_time_seconds }});">Play clip</a>
                                {% else %}
                                    <video id="behavioral_subevent_{{ forloop.counter0 }}_video" class="video-js vjs-default-skin" controls preload="auto"
                                           width="225" height="150" data-setup='{}'>
                                        <source src="{{ sub_behavioral_event.video_url_mp4 }}" type="video/mp4">
                                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                                    </video>
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Start time:</strong> {{ sub_behavioral_event.start_time.hour }}:{{ sub_behavioral_event.start_time.minute }}:{{ sub_behavioral_event.start_time.second }}.{{ sub_behavioral_event.start_time.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Relative to:</strong> {{ sub_behavioral_event.relative_to }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Duration:</strong> {{ sub_behavioral_event.duration.hour }}:{{ sub_behavioral_event.duration.minute }}:{{ sub_behavioral_event.duration.second }}.{{ sub_behavioral_event.duration.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Primates:</strong> {% for primate in sub_behavioral_event.primates.all %}{% if forloop.counter0 > 0%}, {% endif %}<a href="/gbdb/primate/{{ primate.id }}/">{{ primate }}</a>{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Contexts:</strong> {% for context in sub_behavioral_event.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Ethograms:</strong> {% for ethogram in sub_behavioral_event.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Notes:</strong> {{ sub_behavioral_event.notes }}</td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        </div>
        <br>
        <h3>Gestural Sub-Events</h3>
        <div id="sub_gestural_events">
            {% for sub_gestural_event in sub_gestural_events %}
                <div id="sub_gestural_event-{{ forloop.counter }}" name="sub_gestural_event">
                    <table class="tab_panel">
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td width=30%><strong><a href="/gbdb/gestural_event/{{ sub_gestural_event.id }}/">Event {{ forloop.counter }}</a></strong></td>
                            <td rowspan="11">
                                {% if object.video_url_mp4 %}
                                    <a href="" onclick="return playClip({{ sub_gestural_event.start_time_seconds }},{{ sub_gestural_event.end_time_seconds }});">Play clip</a>
                                {% else %}
                                    <video id="gestural_subevent_{{ forloop.counter0 }}_video" class="video-js vjs-default-skin" controls preload="auto"
                                           width="225" height="150" data-setup='{}'>
                                        <source src="{{ sub_gestural_event.video_url_mp4 }}" type="video/mp4">
                                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                                    </video>
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Start time:</strong> {{ sub_gestural_event.start_time.hour }}:{{ sub_gestural_event.start_time.minute }}:{{ sub_gestural_event.start_time.second }}.{{ sub_gestural_event.start_time.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Relative to:</strong> {{ sub_gestural_event.relative_to }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Duration:</strong> {{ sub_gestural_event.duration.hour }}:{{ sub_gestural_event.duration.minute }}:{{ sub_gestural_event.duration.second }}.{{ sub_gestural_event.duration.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Contexts:</strong> {% for context in sub_gestural_event.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Ethograms:</strong> {% for ethogram in sub_gestural_event.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Signaller</strong> <a href="/gbdb/primate/{{ sub_gestural_event.signaller.id }}/">{{ sub_gestural_event.signaller }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Recipient</strong> <a href="/gbdb/primate/{{ sub_gestural_event.recipient.id }}/">{{ sub_gestural_event.recipient }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Gesture</strong> <a href="/gbdb/gesture/{{ sub_gestural_event.gesture.id }}/">{{ sub_gestural_event.gesture }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Recipient response</strong> {{ sub_gestural_event.recipient_response }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Goal met</strong> {{ sub_gestural_event.goal_met }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Notes:</strong> {{ sub_gestural_event.notes }}</td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    {% if user == object.observation_session.collator %}
        <input type="button" value="Edit" onclick="document.location.href='/gbdb/behavioral_event/{{object.id}}/edit/';"/>&nbsp;
        <input type="button" value="Delete" onclick="deleteBehavioralEvent()"/>&nbsp;
    {% endif %}
</div>
{% endblock %}
