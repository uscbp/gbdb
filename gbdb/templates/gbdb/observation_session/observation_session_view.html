{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
    <title>GBDB - View Observation Session</title>
    <link href="{% static 'gbdb/scripts/video-js/video-js.css' %}" rel="stylesheet">
    <script src="{% static 'gbdb/scripts/video-js/video.js' %}"></script>
    <script src="{% static 'gbdb/scripts/video-js/video-framebyframe.js' %}"></script>
    <script src="{% static 'gbdb/scripts/timeline.js' %}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script type="text/javascript">
        function deleteObservationSession()
        {
            if(confirm('This will delete this Observation Session as well as all links to it from other entries. Do you really want to delete the current Observation Session?'))
            {
                var data={'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={type:"POST", url:"/gbdb/observation_session/{{ object.id }}/delete/", data: data, complete: doneDelete };
                $.ajax(args);
            }
        }

        function doneDelete()
        {
            document.location.href='/gbdb/';
        }

        function addBehavioralEvent(id, start_time, duration, start_time_seconds, end_time_seconds, video, primates, contexts, ethograms, notes)
        {
            var count = $('#behavioral_events').children().length;
            var tmplMarkup = $('#behavioral_event-template').html();
            var compiledTmpl = _.template(tmplMarkup, { idx : count+1, id: id, start_time: start_time,
                duration: duration, start_time_seconds:start_time_seconds, end_time_seconds:end_time_seconds, video: video, notes: notes, primates: primates, contexts: contexts, ethograms: ethograms});
            $('#behavioral_events').append(compiledTmpl);
            {% if not object.video.name %}
                videojs("behavioral_event_"+(count+1)+"_video", {}, function(){
                    // Player (this) is initialized and ready.
                });
            {% endif %}
        }
        
        function deleteBehavioralEvent(url)
        {
        	console.log(url);
            if(confirm('This will delete this Behavioral Event as well as all links to it from other entries. Do you really want to delete the current Behavioral Event?'))
            {
                var data={'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={type:"POST", url:url, data: data, complete: doneBehavioralEventDelete };
                $.ajax(args);
            }
        }
        
        function doneBehavioralEventDelete()
        {
            document.location.href='/gbdb/observation_session/{{ object.id }}/';
        }

        function initialize() {
            var map = new google.maps.Map(
                    document.getElementById('map-canvas'), {
                        center: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                        zoom: 13,
                        mapTypeId: google.maps.MapTypeId.HYBRID
                    });

            var marker = new google.maps.Marker({
                position: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                map: map,
                title: '{{ object.location_name }}'
            });
        }
        google.maps.event.addDomListener(window, 'load', initialize);

        function playClip(start_time, end_time)
        {
            videojs("observation_session_video").currentTime(start_time);
            function stopClip(){
                if(this.currentTime()>=end_time)
                {
                    this.pause();
                    this.off('timeupdate',stopClip);
                }
            }
            videojs("observation_session_video").on("timeupdate",stopClip);
            videojs("observation_session_video").play();
            return false;
        };
        
        function setClipTime(start_time)
        {
        	videojs("observation_session_video").currentTime(start_time);
        	return false;
        };
        
        function displayEdit(href)
        {
        	$('#context_data').load(href);
        };
        
        $(document).ready(function()
        {
            videojs.options.flash.swf = "{{ site_url }}/static/gbdb/scripts/video-js/video-js.swf";
            videojs('observation_session_video', {
                plugins: {
                    framebyframe: {
                        fps: 30,
                        steps: [
                            { text: '-5', step: -5 },
                            { text: '-1', step: -1 },
                            { text: '+1', step: 1 },
                            { text: '+5', step: 5 },
                        ]
                    }
                }
            });
            
            var periods = [];
            {% for behavioral_event in behavioral_events %}
            	var period = {time_in:'{{behavioral_event.0.start_time_seconds}}', 
            		time_out:'{{behavioral_event.0.end_time_seconds}}', 
            		track:2, 
            		color:'#'+Math.floor(Math.random()*16777215).toString(16), 
            		label:'{{ forloop.counter }}',
            		content: '{{behavioral_event.0.notes}}'};
            	periods.push(period);
				{% for child in behavioral_event.1 %}
				var period = {time_in:'{{child.start_time_seconds}}', 
            		time_out:'{{child.end_time_seconds}}', 
            		track:1, 
            		color:'#'+Math.floor(Math.random()*16777215).toString(16), 
            		label:'{{ forloop.parentloop.counter }}.{{ forloop.counter }}',
            		content: '{{child.notes}}'};
            	periods.push(period);
				{% endfor %}
			{% endfor %}
            
            videojs("observation_session_video").on("loadedmetadata", function(){
            var options = {
					'height':100,
					'width':this.width(),
					'numberOfTracks':2,
					'cursorHeight':30,
					'periodShape':'bubble',
					'scaleHeight':30,
					'scaleBackgroundColor':'#000', 
					'backgroundColor':'#EAE5E1',
					'scaleColor':'#EAE5E1',
					'trackSeparatorColor':'#EAE5E1', 
					'textColor':'#EAE5E1',
					'cursorColor':'#f00',
					'scaleFactor':2, 
					};
            
					timeline = new Timeline('observation_session_video', 'observation_session_timeline', this.duration(), options);
					var bubbles = [];
					console.log(periods.length);
					for(var i = 0; i<periods.length; i++){
						var id = timeline.addPeriod(periods[i].time_in,periods[i].time_out,periods[i].color, periods[i].track, periods[i].label);
						bubbles.push({id:id, content:periods[i].content});
					}
				});
				
				videojs("observation_session_video").on("timeupdate", function(){
					var time = videojs("observation_session_video").currentTime();
					var active_data = [];
					for(var i=0; i<periods.length-1; i++){
						if(time >= periods[i].time_in && time <= periods[i+1].time_out){
							active_data.push(periods[i].content);
						}
					};
				 	$('#context_data').html(active_data.join('<br /><br />'));
				});
				
		});
        function submitBehavioralEventForm(url, obs_id)
        {
            document.getElementById('savingMsg').style.display = 'block';
            document.getElementById('savingOver').style.display = 'block';
            var frm = $('#behavioralEventForm');
            console.log(url);
            $.ajax({
                type: frm.attr('method'),
                url: url,
                data: frm.serialize(),
                success: doneSubmitBehavioralEventForm
            });
        }

        function doneSubmitBehavioralEventForm(data, status){
            if (status=="success")
            {
                addBehavioralEvent(data.id, data.start_time, data.duration, data.start_time_seconds,
                        data.end_time_seconds, data.video, data.primates, data.contexts, data.ethograms, data.notes);
                $('#context_data').empty();
                document.getElementById('savingMsg').style.display = 'none';
                document.getElementById('savingOver').style.display = 'none';
            }
        }
    </script>
{% endblock %}
{% block content %}
    <div id="detail">
    	<div class="info_panel">
        <h2>Observation Session</h2>
        <table class="tab_panel">
            <tr valign="top">
                <td><strong>Collator:</strong> {{ object.get_collator_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Created:</strong> {{ object.get_created_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Last modified by:</strong> {{ object.get_modified_by_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Last modified:</strong> {{ object.get_modified_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Date:</strong> {{ object.date }}</td>
            <tr valign="top">
                <td><strong>Location: </strong> {{ object.location_name }}</td></td>
            </tr>
            <tr valign="top">
                <td>
                    <div id="map-canvas" style="height:200px"></div>
                </td>
            </tr>
            <tr valign="top">
                <td><strong>Notes:</strong> {{ object.notes }}</td>
            </tr>
        </table>
        {% if user == object.collator %}
            <input type="button" value="Edit" onclick="displayEdit('/gbdb/observation_session/{{object.id}}/edit/')"/>&nbsp;
            <input type="button" value="Delete" onclick="deleteObservationSession()"/>&nbsp;
        {% endif %}

        <br>
        <h3>Behavioral Events{% if user == object.collator %} <a href="#" onclick="displayEdit('/gbdb/behavioral_event/new/?observation_session={{ object.id }}')">Add new</a>{% endif %}</h3>
        <div id="behavioral_events">
            {% for behavioral_event in behavioral_events %}
                <div id="behavioral_event-{{ forloop.counter }}" name="behavioral_event">
                    <table class="tab_panel">
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td width=30%><strong><a href="" onclick="return setClipTime({{ behavioral_event.0.start_time_seconds }})">Behavioral Event {{ forloop.counter }}</a></strong></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                        	<td>
                                {% if object.video_url_mp4 %}
                                    <a href="" onclick="return playClip({{ behavioral_event.0.start_time_seconds }},{{ behavioral_event.0.end_time_seconds }});">Play clip</a>
                                {% else %}
                                    <video id="behavioral_event_{{ forloop.counter0 }}_video"
                                           class="video-js vjs-default-skin" preload="all" width="225" height="150"
                                           controls data-setup='{}'>
                                            <source src="{{ behavioral_event.video_url_mp4 }}" type="video/mp4">
                                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                                    </video>
                                {% endif %}
                            </td>
                        </tr>
                        {% if behavioral_event.0.start_time %}
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Start time:</strong> {{ behavioral_event.0.start_time.hour }}:{{ behavioral_event.0.start_time.minute }}:{{ behavioral_event.0.start_time.second }}</td>
                            </tr>
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Duration:</strong> {{ behavioral_event.0.duration.hour }}:{{ behavioral_event.0.duration.minute }}:{{ behavioral_event.0.duration.second }}</td>
                            </tr>
                        {% endif %}
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Primates:</strong> {% for primate in behavioral_event.0.primates.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ primate }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Contexts:</strong> {% for context in behavioral_event.0.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Ethograms:</strong> {% for ethogram in behavioral_event.0.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Notes:</strong> {{ behavioral_event.0.notes }}</td>
                        </tr>
                    </table>
                    {% if user == object.collator %}
			        <input type="button" value="Edit" onclick="displayEdit('/gbdb/behavioral_event/{{behavioral_event.0.id}}/edit/')"/>&nbsp;
			        <input type="button" value="Delete" onclick="deleteBehavioralEvent('/gbdb/behavioral_event/{{behavioral_event.0.id}}/delete/')"/>&nbsp;
			        {% endif %}
                </div>

        <div id="sub_behavioral_events_list">
        	{% if behavioral_event.1.length > 0 %}
        	<h4>Behavioral and Gestural Sub-Events</h4>
        	{% endif %}
            {% for sub_behavioral_event in behavioral_event.1 %}
                <div id="sub_behavioral_event-{{ forloop.counter }}" name="sub_behavioral_event">
                    <table class="tab_panel">
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td width=30%><strong><a href="" onclick="return setClipTime({{ sub_behavioral_event.start_time_seconds }});">Behavioral Subevent {{ forloop.parentloop.counter }}.{{ forloop.counter }}</a></strong></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                        	<td>
                                {% if object.video_url_mp4 %}
                                    <a href="" onclick="return playClip({{ sub_behavioral_event.start_time_seconds }},{{ sub_behavioral_event.end_time_seconds }});">Play clip</a>
                                {% else %}
                                    <video id="behavioral_subevent_{{ forloop.counter0 }}_video" class="video-js vjs-default-skin" controls preload="auto"
                                           width="225" height="150" data-setup='{}'>
                                        <source src="{{ sub_behavioral_event.video_url_mp4 }}" type="video/mp4">
                                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                                    </video>
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Start time:</strong> {{ sub_behavioral_event.start_time.hour }}:{{ sub_behavioral_event.start_time.minute }}:{{ sub_behavioral_event.start_time.second }}.{{ sub_behavioral_event.start_time.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Relative to:</strong> {{ sub_behavioral_event.relative_to }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Duration:</strong> {{ sub_behavioral_event.duration.hour }}:{{ sub_behavioral_event.duration.minute }}:{{ sub_behavioral_event.duration.second }}.{{ sub_behavioral_event.duration.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Primates:</strong> {% for primate in sub_behavioral_event.primates.all %}{% if forloop.counter0 > 0%}, {% endif %}<a href="/gbdb/primate/{{ primate.id }}/">{{ primate }}</a>{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Contexts:</strong> {% for context in sub_behavioral_event.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Ethograms:</strong> {% for ethogram in sub_behavioral_event.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                        </tr>
                        {% if sub_behavioral_event.type == 'gestural' %}
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Recipient</strong> <a href="/gbdb/primate/{{ sub_behavioral_event.recipient.id }}/">{{ sub_behavioral_event.recipient }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Gesture</strong> <a href="/gbdb/gesture/{{ sub_behavioral_event.gesture.id }}/">{{ sub_behavioral_event.gesture }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Recipient response</strong> {{ sub_behavioral_event.recipient_response }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Goal met</strong> {{ sub_behavioral_event.goal_met }}</td>
                        </tr>
                        {% endif %}
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Notes:</strong> {{ sub_behavioral_event.notes }}</td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        </div>
        {% comment %}
        <h4>Gestural Sub-Events</h4>
        <div id="sub_gestural_events">
            {% for sub_gestural_event in behavioral_event.children.all %}
                <div id="sub_gestural_event-{{ forloop.counter }}" name="sub_gestural_event">
                    <table class="tab_panel">
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td width=30%><strong><a href="/gbdb/gestural_event/{{ sub_gestural_event.id }}/">Event {{ forloop.counter }}</a></strong></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                        	<td rowspan="11">
                                {% if object.video_url_mp4 %}
                                    <a href="" onclick="return playClip({{ sub_gestural_event.start_time_seconds }},{{ sub_gestural_event.end_time_seconds }});">Play clip</a>
                                {% else %}
                                    <video id="gestural_subevent_{{ forloop.counter0 }}_video" class="video-js vjs-default-skin" controls preload="auto"
                                           width="225" height="150" data-setup='{}'>
                                        <source src="{{ sub_gestural_event.video_url_mp4 }}" type="video/mp4">
                                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                                    </video>
                                {% endif %}
                            </td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Start time:</strong> {{ sub_gestural_event.start_time.hour }}:{{ sub_gestural_event.start_time.minute }}:{{ sub_gestural_event.start_time.second }}.{{ sub_gestural_event.start_time.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Relative to:</strong> {{ sub_gestural_event.relative_to }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Duration:</strong> {{ sub_gestural_event.duration.hour }}:{{ sub_gestural_event.duration.minute }}:{{ sub_gestural_event.duration.second }}.{{ sub_gestural_event.duration.microsecond }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Contexts:</strong> {% for context in sub_gestural_event.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Ethograms:</strong> {% for ethogram in sub_gestural_event.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Signaller</strong> <a href="/gbdb/primate/{{ sub_gestural_event.signaller.id }}/">{{ sub_gestural_event.signaller }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Recipient</strong> <a href="/gbdb/primate/{{ sub_gestural_event.recipient.id }}/">{{ sub_gestural_event.recipient }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Gesture</strong> <a href="/gbdb/gesture/{{ sub_gestural_event.gesture.id }}/">{{ sub_gestural_event.gesture }}</a></td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Recipient response</strong> {{ sub_gestural_event.recipient_response }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Goal met</strong> {{ sub_gestural_event.goal_met }}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Notes:</strong> {{ sub_gestural_event.notes }}</td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        </div>

			</script>
			{% endcomment %}
            {% endfor %}
        </div>

    </div>
    
    <div class='video_panel'>
		{% if object.video.name %}
		    <video id="observation_session_video" class="video-js vjs-default-skin" controls preload="auto"
		           width="600" height="400" data-setup='{}'>
		        <source id="observation_session_video_source" src="{{ object.video_url_mp4 }}" type="video/mp4">
		        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
		    </video>
		    <div id="observation_session_timeline"></div>
		{% endif %}
		<div id="context_data"></div>
    </div>
    
    </div>
                
    <script type="text/html" id="behavioral_event-template">
        <div id="behavioral_event-<%= idx %>" name="behavioral_event">
            <table class="tab_panel">
                <tr class="<%= getTRTag(idx) %>">
                    <td width=30%><strong><a href="/gbdb/behavioral_event/<%= id %>/">Event <%= idx %></a></strong></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td>
                    {% if object.video.name %}
                        <a href="" onclick="return playClip(<%= start_time_seconds %>,<%= end_time_seconds %>);">Play clip</a>
                    {% else %}
                        <video id="behavioral_event_<%= idx %>_video"
                               class="video-js vjs-default-skin" preload="all" width="225" height="150"
                               controls data-setup='{}'>
                            <source src="{{ site_url }}/media/<%= video %>" type="video/mp4">
                            <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                        </video>
                    {% endif %}
                    </td>
                </tr>
                <% if(start_time.length>0) { %>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Start time:</strong> <%= start_time %></td>
                    </tr>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Duration:</strong> <%= duration %></td>
                    </tr>
                <% } %>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Primates:</strong> <%= primates %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Contexts:</strong> <%= contexts %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Ethograms:</strong> <%= ethograms %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Notes:</strong> <%= notes %></td>
                </tr>
            </table>
            {% if user == object.collator %}
                <input type="button" value="Edit" onclick="displayEdit('/gbdb/behavioral_event/<%= id %>/edit/')"/>&nbsp;
                <input type="button" value="Delete" onclick="deleteBehavioralEvent('/gbdb/behavioral_event/<%= id %>/delete/')"/>&nbsp;
            {% endif %}
        </div>
    </script>  
{% comment %}
{% load timeline %}
{% timeline %}  
{% endcomment %}
{% endblock %}
