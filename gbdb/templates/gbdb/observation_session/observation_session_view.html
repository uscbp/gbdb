{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
    <title>GBDB - View Observation Session</title>
    <link href="{% static 'gbdb/scripts/video-js/video-js.css' %}" rel="stylesheet">
    <script src="{% static 'gbdb/scripts/video-js/video.js' %}"></script>
    <script src="{% static 'gbdb/scripts/video-framebyframe.js' %}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script type="text/javascript">
        function deleteObservationSession()
        {
            if(confirm('This will delete this Observation Session as well as all links to it from other entries. Do you really want to delete the current Observation Session?'))
            {
                var data={'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={type:"POST", url:"/gbdb/observation_session/{{ object.id }}/delete/", data: data, complete: doneDelete };
                $.ajax(args);
            }
        }

        function doneDelete()
        {
            document.location.href='/gbdb/';
        }

        function addBehavioralEvent(id, start_time, duration, start_time_seconds, end_time_seconds, video, primates, contexts, ethograms, notes)
        {
            var count = $('#behavioral_events').children().length;
            var tmplMarkup = $('#behavioral_event-template').html();
            var compiledTmpl = _.template(tmplMarkup, { idx : count+1, id: id, start_time: start_time,
                duration: duration, start_time_seconds:start_time_seconds, end_time_seconds:end_time_seconds, video: video, notes: notes, primates: primates, contexts: contexts, ethograms: ethograms});
            $('#behavioral_events').append(compiledTmpl);
            {% if not object.video.name %}
                videojs("behavioral_event_"+(count+1)+"_video", {}, function(){
                    // Player (this) is initialized and ready.
                });
            {% endif %}
        }

        function initialize() {
            var map = new google.maps.Map(
                    document.getElementById('map-canvas'), {
                        center: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                        zoom: 13,
                        mapTypeId: google.maps.MapTypeId.HYBRID
                    });

            var marker = new google.maps.Marker({
                position: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                map: map,
                title: '{{ object.location_name }}'
            });
        }
        google.maps.event.addDomListener(window, 'load', initialize);

        function playClip(start_time, end_time)
        {
            videojs("observation_session_video").currentTime(start_time);
            function stopClip(){
                if(this.currentTime()>=end_time)
                {
                    this.pause();
                    this.off('timeupdate',stopClip);
                }
            }
            videojs("observation_session_video").on("timeupdate",stopClip);
            videojs("observation_session_video").play();
            return false;
        }

        $(document).ready(function()
        {
            videojs.options.flash.swf = "{{ site_url }}/static/gbdb/scripts/video-js/video-js.swf";
            videojs('observation_session_video', {
                plugins: {
                    framebyframe: {
                        fps: 30,
                        steps: [
                            { text: '-5', step: -5 },
                            { text: '-1', step: -1 },
                            { text: '+1', step: 1 },
                            { text: '+5', step: 5 },
                        ]
                    }
                }
            });
        });
    </script>
{% endblock %}
{% block content %}
    <div id="detail">
        <h2>Observation Session</h2>
        <table class="tab_panel">
            <tr valign="top">
                <td><strong>Collator:</strong> {{ object.get_collator_str }}</td>
                {% if object.video.name %}
                    <td>&nbsp;&nbsp;&nbsp;</td>
                    <td colspan="2" rowspan="8">
                        <video id="observation_session_video" class="video-js vjs-default-skin" controls preload="auto"
                               width="450" height="300" data-setup='{}'>
                            <source id="observation_session_video_source" src="{{ object.video_url_mp4 }}" type="video/mp4">
                            <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                        </video>
                    </td>
                {% endif %}
            </tr>
            <tr valign="top">
                <td><strong>Created:</strong> {{ object.get_created_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Last modified by:</strong> {{ object.get_modified_by_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Last modified:</strong> {{ object.get_modified_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Date:</strong> {{ object.date }}</td>
            <tr valign="top">
                <td><strong>Location: </strong> {{ object.location_name }}</td></td>
            </tr>
            <tr valign="top">
                <td>
                    <div id="map-canvas" style="height:200px"></div>
                </td>
            </tr>
            <tr valign="top">
                <td><strong>Notes:</strong> {{ object.notes }}</td>
            </tr>
        </table>

        <br>
        <h3>Behavioral Events{% if user == object.collator %} <a href="#" onclick="return showPopup('Add Behavioral Event',1000,500,'/gbdb/behavioral_event/new/?observation_session={{ object.id }}');">Add new</a>{% endif %}</h3>
        <div id="behavioral_events">
            {% for behavioral_event in behavioral_events %}
                <div id="behavioral_event-{{ forloop.counter }}" name="behavioral_event">
                    <table class="tab_panel">
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td width=30%><strong><a href="/gbdb/behavioral_event/{{ behavioral_event.id }}/">Event {{ forloop.counter }}</a></strong></td>
                            <td rowspan="7">
                                {% if object.video_url_mp4 %}
                                    <a href="" onclick="return playClip({{ behavioral_event.start_time_seconds }},{{ behavioral_event.end_time_seconds }});">Play clip</a>
                                {% else %}
                                    <video id="behavioral_event_{{ forloop.counter0 }}_video"
                                           class="video-js vjs-default-skin" preload="all" width="225" height="150"
                                           controls data-setup='{}'>
                                            <source src="{{ behavioral_event.video_url_mp4 }}" type="video/mp4">
                                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                                    </video>
                                {% endif %}
                            </td>
                        </tr>
                        {% if behavioral_event.start_time %}
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Start time:</strong> {{ behavioral_event.start_time.hour }}:{{ behavioral_event.start_time.minute }}:{{ behavioral_event.start_time.second }}</td>
                            </tr>
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Duration:</strong> {{ behavioral_event.duration.hour }}:{{ behavioral_event.duration.minute }}:{{ behavioral_event.duration.second }}</td>
                            </tr>
                        {% endif %}
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Primates:</strong> {% for primate in behavioral_event.primates.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ primate }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Contexts:</strong> {% for context in behavioral_event.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Ethograms:</strong> {% for ethogram in behavioral_event.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Notes:</strong> {{ behavioral_event.notes }}</td>
                        </tr>
                    </table>
                </div>
            {% endfor %}
        </div>
        {% if user == object.collator %}
            <input type="button" value="Edit" onclick="document.location.href='/gbdb/observation_session/{{object.id}}/edit/';"/>&nbsp;
            <input type="button" value="Delete" onclick="deleteObservationSession()"/>&nbsp;
        {% endif %}
    </div>
    <script type="text/html" id="behavioral_event-template">
        <div id="behavioral_event-<%= idx %>" name="behavioral_event">
            <table class="tab_panel">
                <tr class="<%= getTRTag(idx) %>">
                    <td width=30%><strong><a href="/gbdb/behavioral_event/<%= id %>/">Event <%= idx %></a></strong></td>
                    <td rowspan="7">
                        {% if object.video.name %}
                            <a href="" onclick="return playClip(<%= start_time_seconds %>,<%= end_time_seconds %>);">Play clip</a>
                        {% else %}
                            <video id="behavioral_event_<%= idx %>_video"
                                   class="video-js vjs-default-skin" preload="all" width="225" height="150"
                                   controls data-setup='{}'>
                                <source src="{{ site_url }}/media/<%= video %>" type="video/mp4">
                                <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                            </video>
                        {% endif %}
                    </td>
                </tr>
                <% if(start_time.length>0) { %>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Start time:</strong> <%= start_time %></td>
                    </tr>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Duration:</strong> <%= duration %></td>
                    </tr>
                <% } %>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Primates:</strong> <%= primates %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Contexts:</strong> <%= contexts %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Ethograms:</strong> <%= ethograms %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Notes:</strong> <%= notes %></td>
                </tr>
            </table>
        </div>
    </script>  
{% load timeline %}
{% timeline %}  
{% endblock %}
