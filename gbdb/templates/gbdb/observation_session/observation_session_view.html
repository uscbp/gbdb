{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
    <title>GBDB - View Observation Session</title>
    <link href="{% static 'gbdb/scripts/video-js/video-js.css' %}" rel="stylesheet">
    <script src="{% static 'gbdb/scripts/video-js/video.js' %}"></script>
    <script src="{% static 'gbdb/scripts/video-js/video-framebyframe.js' %}"></script>
    <script src="{% static 'gbdb/scripts/timeline.js' %}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script type="text/javascript">

        function initialize() {
            var map = new google.maps.Map(
                    document.getElementById('map-canvas'), {
                        center: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                        zoom: 5,
                        mapTypeId: google.maps.MapTypeId.HYBRID
                    });

            var marker = new google.maps.Marker({
                position: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                map: map,
                title: '{{ object.location_name }}'
            });
        }
        google.maps.event.addDomListener(window, 'load', initialize);

        function playClip(start_time, end_time)
        {
            videojs("observation_session_video").currentTime(start_time);
            function stopClip(){
                if(this.currentTime()>=end_time)
                {
                    this.pause();
                    this.off('timeupdate',stopClip);
                }
            }
            videojs("observation_session_video").on("timeupdate",stopClip);
            videojs("observation_session_video").play();
            return false;
        }
        
        function playWholeClip()
        {
            videojs("observation_session_video").currentTime(0);
            videojs("observation_session_video").play();
            return false;
        }
        
        function setClipTime(start_time)
        {
        	videojs("observation_session_video").currentTime(start_time);
        	return false;
        }
        
        function addPeriod(time_in, time_out, track, label, content)
        {
        	var color = '#33CCFF';
        	if(track == 1){
        		color = '#99FF66';
        	}
        	//var id = timeline.addPeriod(time_in, time_out,'#'+Math.floor(Math.random()*16777215).toString(16), track, label);
        	var id = timeline.addPeriod(time_in, time_out, color, track, label);
        }
        
        function drawTimeline()
        {       
        	
        	$('#observation_session_timeline').html("");
        	var options = {
                        'height':100,
                        'width':videojs("observation_session_video").width(),
                        'numberOfTracks':2,
                        'cursorHeight':30,
                        //'periodShape':'bubble',
                        'scaleHeight':30,
                        'scaleBackgroundColor':'#000',
                        'backgroundColor':'#EAE5E1',
                        'scaleColor':'#EAE5E1',
                        'trackSeparatorColor':'#EAE5E1',
                        'textColor':'#EAE5E1',
                        'cursorColor':'#f00',
                        'scaleFactor':2
                        };

            timeline = new Timeline('observation_session_video', 'observation_session_timeline', videojs("observation_session_video").duration(), options);
            for(var i = 0; i<periods.length; i++){
            	var color = '#33CCFF';
	        	if(periods[i]['data'].track == 1){
	        		color = '#99FF66';
	        	}
                //id = timeline.addPeriod(periods[i]['data'].start_time_seconds,periods[i]['data'].end_time_seconds, '#'+Math.floor(Math.random()*16777215).toString(16), periods[i]['data'].track, periods[i]['data'].label);
            	id = timeline.addPeriod(periods[i]['data'].start_time_seconds,periods[i]['data'].end_time_seconds, color, periods[i]['data'].track, periods[i]['data'].label);
            }
        }

        $(document).ready(function()
        {
        	periods = [];
        	drawTimeline();
            videojs.options.flash.swf = "{{ site_url }}/static/gbdb/scripts/video-js/video-js.swf";
           
                videojs('observation_session_video', {
                    plugins: {
                        framebyframe: {
                            fps: 30,
                            steps: [
                                { text: '-5', step: -5 },
                                { text: '-1', step: -1 },
                                { text: '+1', step: 1 },
                                { text: '+5', step: 5 }
                            ]
                        }
                    }
                });
				
				{% for behavioral_event in behavioral_events %}
					var count = '{{ forloop.counter }}';
					var period =  {
                        id:'{{behavioral_event.id}}',
                        data: {
                            id:'{{behavioral_event.id}}',
                            idx: count,
                            label: count.toString(),
                            start_time: '{{behavioral_event.0.start_time}}',
                            duration: '{{behavioral_event.0.duration}}',
                            start_time_seconds: '{{behavioral_event.0.start_time_seconds}}',
                            end_time_seconds: '{{behavioral_event.0.end_time_seconds}}',
                            video: '{{behavioral_event.0.video}}',
                            video_url_mp4: '{{behavioral_event.0.video_url_mp4}}',
                            notes: '{{behavioral_event.0.notes|linebreaks}}',
                            primates: '{{behavioral_event.0.primates}}',
                            contexts: '{{behavioral_event.0.contexts}}',
                            ethograms: '{{behavioral_event.0.ethograms}}',
                            track: 2
                        }
                    };
				
	                // var period = {time_in:'{{behavioral_event.0.start_time_seconds}}',
	                    // time_out:'{{behavioral_event.0.end_time_seconds}}',
	                    // track:2,
	                    // color:'#'+Math.floor(Math.random()*16777215).toString(16),
	                    // label:'{{ forloop.counter }}',
	                    // content: '{{behavioral_event.0.notes|linebreaks}}'};
	                 periods.push(period);
	                {% for child in behavioral_event.1 %}
                        var sub_count = '{{ forloop.counter }}';
                        period = {
                            id:'{{child.id}}',
                            data: {
                                parentIdx: count,
                                idx: sub_count+1,
                                label: count.toString() + '.' + sub_count.toString(),
                                start_time_seconds: '{{child.start_time_seconds}}',
                                end_time_seconds: '{{child.end_time_seconds}}',
                                type: '{{child.type}}',
                                start_time: '{{child.start_time}}',
                                relative_to: '{{child.relative_to}}',
                                duration: '{{child.duration}}',
                                primates: '{{child.primates}}',
                                contexts: '{{child.contexts}}',
                                ethograms: '{{child.ethograms}}',
                                signaller_id: '{{child.signaller_id}}',
                                signaller:'{{child.signaller}}',
                                recipient_id: '{{child.recipient_id}}',
                                recipient: '{{child.recipient}}',
                                gesture_id: '{{child.gesture_id}}',
                                gesture:'{{child.gesture}}',
                                recipient_response: '{{child.recipient_response}}',
                                goal_met: '{{child.goal_met}}',
                                notes: '{{child.notes|linebreaks}}',
                                track: 1
                            }
                        };
                        // var period = {time_in:'{{child.start_time_seconds}}',
                            // time_out:'{{child.end_time_seconds}}',
                            // track:1,
                            // color:'#'+Math.floor(Math.random()*16777215).toString(16),
                            // label:'{{ forloop.parentloop.counter }}.{{ forloop.counter }}',
                            // content: '{{child.notes|linebreaks}}'};
                        periods.push(period);
	                {% endfor %}
	            {% endfor %}
            
                videojs("observation_session_video").on("loadedmetadata", function(){
                	drawTimeline();
                });

                videojs("observation_session_video").on("timeupdate", function(){
                    var time = videojs("observation_session_video").currentTime();
                    var active_data = [];
                    var min_start_time=10000000;
                    var min_label='';
                    var period_flag = false;
                    for(var i=0; i<periods.length; i++){
                        if(time >= periods[i]['data'].start_time_seconds && time < periods[i]['data'].end_time_seconds){
                            active_data.push("<strong>Event " + periods[i]['data'].label + " Notes: </strong>" +periods[i]['data'].notes);
                        	if(periods[i]['data'].label.indexOf('.')<0)
                                $('#behavioral_event-' + periods[i]['data'].label).css("border","5px solid #FF0");
                            else
                                $('#sub_behavioral_event-' + periods[i]['data'].label).css("border","5px solid #FF0");
                            if(periods[i].data.start_time_seconds<min_start_time)
                            {
                                min_start_time=periods[i].data.start_time_seconds;
                                min_label=periods[i]['data'].label;
                            }
                            period_flag = true;

                        } else {
                            if(periods[i]['data'].label.indexOf('.')<0)
                        	    $('#behavioral_event-' + periods[i]['data'].label).css("border","none");
                            else
                        	    $('#sub_behavioral_event-' + periods[i]['data'].label).css("border","none");
                        }
                    };
                    if(period_flag) {
	                    if(min_label.indexOf('.')>=0)
	                        $("#behavioral_events").scrollTo("#behavioral_event-" + min_label.substring(0,min_label.indexOf('.')));
	                    else
	                        $("#behavioral_events").scrollTo("#behavioral_event-" + min_label);
	                       }
                    $('#context_data').html(active_data.join('<br /><br />'));
                });
            
        });

        behavioralEventEditIdx=-1;
        behavioralSubEventEditIdx=-1;

        function editBehavioralSubEvent(id, idx, parentIdx)
        {
            $('#context_data').load('/gbdb/behavioral_event/'+id+'/edit/');
            behavioralEventEditIdx=parentIdx;
            behavioralSubEventEditIdx=idx;
            return false;
        }

        function createBehavioralSubEvent(parent_id, parentIdx)
        {
            $('#context_data').load('/gbdb/behavioral_event/new/?observation_session={{ object.id }}&parent_event='+parent_id);
            behavioralEventEditIdx=parentIdx;
            behavioralSubEventEditIdx=-1;
            return false;
        }

        function submitBehavioralSubEventForm(url)
        {
            document.getElementById('savingMsg').style.display = 'block';
            document.getElementById('savingOver').style.display = 'block';
            var frm = $('#behavioralEventForm');
            var data = new FormData(frm.get(0));
            $.ajax({
                url: url,
                type: frm.attr('method'),
                data: data,
                complete: doneSubmitBehavioralSubEventForm,
                processData: false,
                contentType: false
            });
        }

        /**
         * Called after behavioral subevent form post response
         * @param res - request result
         * @param status - reponse status
         */
        function doneSubmitBehavioralSubEventForm(res, status)
        {
            // Parse response text
            var txt = res.responseText;
            var data = eval('('+txt+')');

            // Successful form submission
            if (status=="success")
            {
                // Clear menu area
                $('#context_data').empty();

                // Get template for subevent
                var tmplMarkup = $('#behavioral_subevent-template').html();

                // Number of other subevents in parent event
                var count = $('#sub_behavioral_events_list-'+behavioralEventEditIdx).children("[id^=sub_behavioral_event]").length;

                // Data structure for subevent - used to draw timeline and fill in subevent template
                period = {
                    id: data['id'],
                    data:{
                        id: data['id'],
                        parentIdx: behavioralEventEditIdx,
                        start_time_seconds: data['start_time_seconds'],
                        end_time_seconds: data['end_time_seconds'],
                        type: data['type'],
                        start_time: data['start_time'],
                        relative_to: data['relative_to'],
                        duration: data['duration'],
                        primates: data['primates'],
                        contexts: data['contexts'],
                        ethograms: data['ethograms'],
                        signaller_id: data['signaller_id'],
                        signaller: data['signaller'],
                        recipient_id: data['recipient_id'],
                        recipient: data['recipient'],
                        gesture_id: data['gesture_id'],
                        gesture: data['gesture'],
                        recipient_response: data['recipient_response'],
                        goal_met: data['goal_met'],
                        notes: data['notes'],
                        track: 1
                    }
                };

                // Added a new subevent
                if(behavioralSubEventEditIdx<0)
                {
                    // Set data idx and label based on count of other subevents in parent event
                    period['data']['idx']=count+1;
                    period['data']['label']=(behavioralEventEditIdx).toString() + '.' + (count+1).toString();

                    // Add to list of periods
                    periods.push(period);

                    // Fill in template
                    var compiledTmpl = _.template(tmplMarkup, period['data']);

                    // No other subevents - add to end of parent event subevent list
                    if(count==0)
                        $(document.getElementById('sub_behavioral_events_list-'+behavioralEventEditIdx)).append(compiledTmpl);
                    // Figure out where to insert subevent
                    else
                    {
                        $('#sub_behavioral_events_list-'+behavioralEventEditIdx).children("[id^=sub_behavioral_event]").each(function(index){
                            var thisElemStart=parseInt(this.getElementsByClassName('sub_behavioral_event-start_time_seconds')[0].textContent);
                            if(data.start_time_seconds<thisElemStart)
                            {
                                $(this).before(compiledTmpl);
                                return false;
                            }
                            // Add after only subevent
                            else if(index==(count-1))
                            {
                                $(document.getElementById('sub_behavioral_events_list-'+behavioralEventEditIdx)).append(compiledTmpl);
                                return false;
                            }
                            else
                            {
                                // Insert between this subevent and the next
                                var nextElemStart=parseInt($('#sub_behavioral_events_list-'+behavioralEventEditIdx).children("[id^=sub_behavioral_event]")[index+1].getElementsByClassName('sub_behavioral_event-start_time_seconds')[0].textContent);
                                if(data.start_time_seconds>=thisElemStart && data.start_time_seconds<=nextElemStart)
                                {
                                    $(this).after(compiledTmpl);
                                    return false;
                                }
                            }
                        });
                    }
                }
                // Update existing subevent
                else
                {
                    // Set data idx and label based on currently edited subevent
                    period['data']['idx']=behavioralSubEventEditIdx;
                    period['data']['label']=behavioralEventEditIdx.toString() + '.' + (behavioralSubEventEditIdx).toString();

                    // Update existing period
                    var found=false;
                    for(var i=0; i<periods.length; i++)
                    {
                        if(periods[i].parentIdx==period.parentIdx && periods[i].id==period.id)
                        {
                            periods[i]=period;
                            found=true;
                            break;
                        }
                    }
                    if(!found)
                        periods.push(period);

                    // Fill in template
                    var compiledTmpl = _.template(tmplMarkup, period['data']);

                    // Update subevent in parent subevent list
                    $(document.getElementById('sub_behavioral_event-'+behavioralEventEditIdx+'.'+behavioralSubEventEditIdx)).replaceWith(compiledTmpl);
                }

                // parent event contexts
                var parentContexts=document.getElementById('behavioral_event-'+behavioralEventEditIdx+'-contexts').textContent.split(', ');
                var subEventContexts=period['data']['contexts'].split(', ');
                for(var i=0; i<subEventContexts.length; i++)
                {
                    // Look for subevent context in parent event
                    var found=false;
                    for(var j=0; j<parentContexts.length; j++)
                    {
                        if(subEventContexts[i]==parentContexts[j])
                        {
                            found=true;
                            break;
                        }
                    }
                    // If not found, add to parent contexts
                    if(!found)
                    {
                        parentContexts.push(subEventContexts[i]);
                    }
                }
                // Update parent contexts
                contextString='';
                if(parentContexts.length>1)
                    contextString=parentContexts.join(', ');
                else if(parentContexts.length>0)
                    contextString=parentContexts[0];
                document.getElementById('behavioral_event-'+behavioralEventEditIdx+'-contexts').textContent=contextString;

                // parent event ethograms
                var parentEthograms=document.getElementById('behavioral_event-'+behavioralEventEditIdx+'-ethograms').textContent.split(', ');
                var subEventEthograms=period['data']['ethograms'].split(', ');
                for(var i=0; i<subEventEthograms.length; i++)
                {
                    // Look for subevent ethogram in parent event
                    var found=false;
                    for(var j=0; j<parentEthograms.length; j++)
                    {
                        if(subEventEthograms[i]==parentEthograms[j])
                        {
                            found=true;
                            break;
                        }
                    }
                    // If not found, add to parent ethograms
                    if(!found)
                    {
                        parentEthograms.push(subEventEthograms[i]);
                    }
                }
                // Update parent ethograms
                ethogramString='';
                if(parentEthograms.length>1)
                    ethogramString=parentEthograms.join(', ');
                else if(parentEthograms.length>0)
                    ethogramString=parentEthograms[0];
                document.getElementById('behavioral_event-'+behavioralEventEditIdx+'-ethograms').textContent=ethogramString;

                // parent event primates
                var parentPrimates=document.getElementById('behavioral_event-'+behavioralEventEditIdx+'-primates').textContent.split(', ');
                var subEventPrimates=period['data']['primates'].split(', ');
                for(var i=0; i<subEventPrimates.length; i++)
                {
                    // Look for subevent primate in parent event
                    var found=false;
                    for(var j=0; j<parentPrimates.length; j++)
                    {
                        if(subEventPrimates[i]==parentPrimates[j])
                        {
                            found=true;
                            break;
                        }
                    }
                    // If not found, add to parent primates
                    if(!found)
                    {
                        parentPrimates.push(subEventPrimates[i]);
                    }
                }
                // Update parent primates
                primateString='';
                if(parentPrimates.length>1)
                    primateString=parentPrimates.join(', ');
                else if(parentPrimates.length>0)
                    primateString=parentPrimates[0];
                document.getElementById('behavioral_event-'+behavioralEventEditIdx+'-primates').textContent=primateString;

                // Reset edit indices
                behavioralEventEditIdx=-1;
                behavioralSubEventEditIdx=-1;

                // Draw timeline
                drawTimeline();
            }
            // Process errors
            else
            {
                // Reset error labels
                $('.error_label').each(function(index, element){
                    $( this ).html('');
                });
                // Set error labels
                for(var property in data.errors)
                {
                    error_str='';
                    for(var i=0; i<data.errors[property].length; i++)
                    {
                        if(i>0)
                            error_str+='<br>';
                        error_str+=data.errors[property][i];
                    }
                    $('#id_'+property+'_errors').html(error_str);
                }
            }

            // Remove saving msg
            document.getElementById('savingMsg').style.display = 'none';
            document.getElementById('savingOver').style.display = 'none';
        }

        function deleteBehavioralSubEvent(id, idx, parentIdx)
        {
            if(confirm('This will delete this SubEvent as well as all links to it from other entries. Do you really want to delete the current SubEvent?'))
            {
                var data={'idx':idx, 'parentIdx':parentIdx, 'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={
                    type:"POST",
                    url:'/gbdb/behavioral_event/'+id+'/delete/',
                    data: data,
                    success: doneBehavioralSubEventDelete };
                $.ajax(args);
            }
        }

        function doneBehavioralSubEventDelete(data, status)
        {
            if(status=='success')
            {
                $(document.getElementById('sub_behavioral_event-'+data.parentIdx+'.'+data.idx)).remove();
                for(var i=0; i<periods.length; i++)
                {
                    if(periods[i].data.label==data.parentIdx.toString()+'.'+data.idx.toString())
                    {
                        periods.splice(i,1);
                        break
                    }
                }
                drawTimeline();
                $('#context_data').empty();
            }
        }

        function editBehavioralEvent(id, idx)
        {
            $('#context_data').load('/gbdb/behavioral_event/'+id+'/edit/');
            behavioralEventEditIdx=idx;
            return false;
        }

        function createBehavioralEvent()
        {
            $('#context_data').load('/gbdb/behavioral_event/new/?observation_session={{ object.id }}');
            behavioralEventEditIdx=-1;
            return false;
        }

        function submitBehavioralEventForm(url)
        {
            document.getElementById('savingMsg').style.display = 'block';
            document.getElementById('savingOver').style.display = 'block';
            var frm = $('#behavioralEventForm');
            var data = new FormData(frm.get(0));
	        $.ajax({
	            url: url,
    			type: frm.attr('method'),
	            data: data,
	            complete: doneSubmitBehavioralEventForm,
	            processData: false,
	            contentType: false
	        });
        }
        
        function changeVideoSource(source){
        	document.getElementById('observation_session_video_source').src = source;
        	videojs("observation_session_video").load();
        	return false;
        }

        /**
         * Called after behavioral event form post response
         * @param res - request result
         * @param status - reponse status
         */
        function doneSubmitBehavioralEventForm(res, status)
        {
            // Parse response text
            var txt = res.responseText;
            var data = eval('('+txt+')');

            // Successful form submission
            if (status=="success")
            {
                // Clear menu area
                $('#context_data').empty();

                // Get template for subevent
                var tmplMarkup = $('#behavioral_event-template').html();

                // Number of other events in observation session
                var count = $('#behavioral_events').children("[id^=behavioral_event]").length;

                // Data strutcture for event - used to draw timeline and fill in event template
                var period = {
                    id: data.id,
                    data: {
                        id: data.id,
                        start_time: data.start_time,
                        duration: data.duration,
                        start_time_seconds: data.start_time_seconds,
                        end_time_seconds: data.end_time_seconds,
                        video: data.video,
                        video_url_mp4: data.video_url_mp4,
                        notes: data.notes,
                        primates: data.primates,
                        contexts: data.contexts,
                        ethograms: data.ethograms,
                        track: 2
                    }
                };

                // Added a new event
                if(behavioralEventEditIdx<0)
                {
                    // Set data idx and label based on count of other events in obs session
                    period['data']['idx']=count+1;
                    period['data']['label']=(count+1).toString();

                    // Add to list of periods
                    periods.push(period);

                    // Fill in template
                    var compiledTmpl = _.template(tmplMarkup, period['data']);

                    // No other events - add to end of ob session event list
                    if(count==0)
                        $('#behavioral_events').append(compiledTmpl);
                    // Figure out where to insert event
                    else
                    {
                        $('#behavioral_events').children("[id^=behavioral_event]").each(function(index)
                        {
                            // Insert after this event
                            var thisElemStart=parseInt(this.getElementsByClassName('behavioral_event-start_time_seconds')[0].textContent);
                            if(data.start_time_seconds<thisElemStart)
                            {
                                $(this).before(compiledTmpl);
                                return false;
                            }
                            // Add after only subevent
                            else if(index==(count-1))
                            {
                                $(document.getElementById('behavioral_events')).append(compiledTmpl);
                                return false;
                            }
                            else
                            {
                                // Insert between this subevent and the next
                                var nextElemStart=parseInt($('#behavioral_events').children("[id^=behavioral_event]")[index+1].getElementsByClassName('behavioral_event-start_time_seconds')[0].textContent);
                                if(data.start_time_seconds>=thisElemStart && data.start_time_seconds<=nextElemStart)
                                {
                                    $(this).after(compiledTmpl);
                                    return false;
                                }
                            }
                        });
                    }

                    {% if not object.video.name %}
                        document.getElementById('observation_session_video_source').src = data.video_url_mp4;
                        $("#video_frame").css("display", "block");
                        videojs("observation_session_video").load();
                    {% endif %}
                    drawTimeline();
                }
                // Update existing event
                else
                {
                    // Set data idx and label based on currently edited event
                    period['data']['idx']=behavioralEventEditIdx;
                    period['data']['label']=behavioralEventEditIdx.toString();

                    // Update existing period
                    {% if object.video.name %}
                        var found=false;
                        for(var i=0; i<periods.length; i++)
                        {
                            if(periods[i].data.label==period.data.label)
                            {
                                periods[i]=period;
                                found=true;
                                break;
                            }
                        }
                        if(!found)
                            periods.push(period);
                    {% endif %}

                    // Fill in template
                    var compiledTmpl = _.template(tmplMarkup, period['data']);

                    // Save subevent text
                    var subEventTxt=$(document.getElementById('sub_behavioral_events_list-'+behavioralEventEditIdx)).html();
                    // Update event in obs session event list
                    $('#behavioral_event-'+behavioralEventEditIdx).replaceWith(compiledTmpl);
                    // Replace subevent text
                    $(document.getElementById('sub_behavioral_events_list-'+behavioralEventEditIdx)).html(subEventTxt);

                    // Reset edit index
                    behavioralEventEditIdx=-1;

                    // Load video
                    {% if not object.video.name %}
                        document.getElementById('observation_session_video_source').src = data.video_url_mp4;
                        $("#video_frame").css("display", "block");
                        videojs("observation_session_video").load();
                    {% endif %}

                    // Draw timeline
                    drawTimeline();
                }
            }
            // Process errors
            else
            {
                // Reset error labels
                $('.error_label').each(function(index, element){
                    $( this ).html('');
                });
                // Set error labels
                for(var property in data.errors)
                {
                    var error_str='';
                    for(var i=0; i<data.errors[property].length; i++)
                    {
                        if(i>0)
                            error_str+='<br>';
                        error_str+=data.errors[property][i];
                    }
                    $('#id_'+property+'_errors').html(error_str);
                }
            }
            // Remove saving msg
            document.getElementById('savingMsg').style.display = 'none';
            document.getElementById('savingOver').style.display = 'none';
        }

        function deleteBehavioralEvent(id, idx)
        {
            if(confirm('This will delete this Behavioral Event as well as all links to it from other entries. Do you really want to delete the current Behavioral Event?'))
            {
                var data={'idx':idx, 'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={
                    type:"POST",
                    url:'/gbdb/behavioral_event/'+id+'/delete/',
                    data: data,
                    success: doneBehavioralEventDelete };
                $.ajax(args);
            }
        }

        function doneBehavioralEventDelete(data, status)
        {
            if(status=='success')
            {
                $(document.getElementById('behavioral_event-'+data.idx)).remove();
                var removed=true;
                while(removed)
                {
                    removed=false;
                    for(var i=0; i<periods.length; i++)
                    {
                        if(periods[i].data.label==data.idx.toString())
                        {
                            periods.splice(i,1);
                            removed=true;
                            break
                        }
                        else if(periods[i].data.label.substring(0,data.idx.toString().length+1)==data.idx.toString()+'.')
                        {
                            periods.splice(i,1);
                            removed=true;
                            break
                        }
                    }
                }
                drawTimeline();
                {% if not object.video.name %}
                    var count = $('#behavioral_events').children("[id^=behavioral_event]").length;
                    if(count == 0){
                        document.getElementById('observation_session_video_source').src = "";
                        $("#video_frame").css("display", "none");
                    }
                {% endif %}
                $('#context_data').empty();
            }
        }

        function editObservationSession(href)
        {
            $('#context_data').load(href);
        }

        function submitObservationSessionForm(url, obs_id)
        {
            document.getElementById('savingMsg').style.display = 'block';
            document.getElementById('savingOver').style.display = 'block';
            var frm = $('#observationSessionForm');
            var data = new FormData(frm.get(0));
            $.ajax({
                url: url,
                type: frm.attr('method'),
                data: data,
                complete: doneSubmitObservationSession,
                processData: false,
                contentType: false
            });
        }

        function doneSubmitObservationSession(res, status){
            document.getElementById('savingMsg').style.display = 'none';
            document.getElementById('savingOver').style.display = 'none';
            var txt = res.responseText;
            var data = eval('('+txt+')');
            if(status=='success')
            {
                document.location.reload();
            }
            else{
                $('.error_label').each(function(index, element){
                    $( this ).html('');
                });
                for(var property in data)
                {
                    error_str='';
                    for(var i=0; i<data[property].length; i++)
                    {
                        if(i>0)
                            error_str+='<br>';
                        error_str+=data[property][i]
                    }
                    $('#id_'+property+'_errors').html(error_str);
                }
            }
        }

        function deleteObservationSession()
        {
            if(confirm('This will delete this Observation Session as well as all links to it from other entries. Do you really want to delete the current Observation Session?'))
            {
                var data={'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={type:"POST", url:"/gbdb/observation_session/{{ object.id }}/delete/", data: data, complete: doneDeleteObservationSession };
                $.ajax(args);
            }
        }

        function doneDeleteObservationSession()
        {
            document.location.href='/gbdb/';
        }

        function managePermissions(documentId)
			{
				//$('#context_data').load(href);
			    return showPopup('Manage permissions',600,500,'/gbdb/observation_session/'+documentId+'/permissions/');
			}


    </script>
{% endblock %}
{% block content %}
    <div id="detail">
    	<div class="info_panel">
            <h2>Observation Session</h2>
            <table class="tab_panel">
                <tr valign="top">
                    <td><strong>Collator:</strong> {{ object.get_collator_str }}</td>
                </tr>
                <tr valign="top">
                    <td><strong>Created:</strong> {{ object.get_created_str }}</td>
                </tr>
                <tr valign="top">
                    <td><strong>Last modified by:</strong> {{ object.get_modified_by_str }}</td>
                </tr>
                <tr valign="top">
                    <td><strong>Last modified:</strong> {{ object.get_modified_str }}</td>
                </tr>
                <tr valign="top">
                    <td><strong>Date:</strong> {{ object.date }}</td>
                <tr valign="top">
                    <td><strong>Location: </strong> {{ object.location_name }}</td></td>
                </tr>
                <tr valign="top">
                    <td><strong>Notes: </strong> {{ object.notes }}</td></td>
                </tr>
                <tr valign="top">
                    <td>
                        <div id="map-canvas" style="height:200px"></div>
                    </td>
                </tr>
            </table>
         
            	{% if user == object.collator or has_edit_perms %}
                <input type="button" value="Edit" onclick="editObservationSession('/gbdb/observation_session/{{object.id}}/edit/')"/>&nbsp;
                {% endif %}
                {% if user == object.collator or has_delete_perms %}
                <input type="button" value="Delete" onclick="deleteObservationSession()"/>&nbsp;
                {% endif %}
                {% if user == object.collator or has_manage_perms %}
                <input id="manageButton" class="btn" type="button" value="Manage Permissions" onclick="return managePermissions('{{object.id}}');" onmouseover="this.className='btn btnhov'" onmouseout="this.className='btn'"/>&nbsp;
            	{% endif %}

            <br>
            <h3>Behavioral Events{% if user == object.collator %} <a href="#" onclick="return createBehavioralEvent();">Add new</a>{% endif %}</h3>
            <div id="behavioral_events">
                {% for behavioral_event in behavioral_events %}
                    <div id="behavioral_event-{{ forloop.counter }}" name="behavioral_event">
                        <div id="behavioral_event-{{ forloop.counter }}-start_time_seconds" class="behavioral_event-start_time_seconds" style="display: none;">{{ behavioral_event.0.start_time_seconds }}</div>
                        <table class="tab_panel">
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                {% if not behavioral_event.0.video.name %}
                                <td width=30%><strong><a href="" onclick="return setClipTime({{ behavioral_event.0.start_time_seconds }})">Behavioral Event {{ forloop.counter }}</a></strong></td>
                                {% else %}
                                <td width=30%><strong><a href="" onclick="return changeVideoSource('{{ behavioral_event.0.video_url_mp4 }}')">Behavioral Event {{ forloop.counter }}</a></strong></td>
                                {% endif %}
                            </tr>
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td>
                                    {% if not behavioral_event.0.video.name %}
                                        <a href="" onclick="return playClip({{ behavioral_event.0.start_time_seconds }},{{ behavioral_event.0.end_time_seconds }});">Play clip</a>
                                    {% else %}
                                        <a href="" onclick="return playWholeClip();">Play clip</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if not behavioral_event.0.video.name %}
                                <tr class="{% cycle 'even_row' 'odd_row' %}">
                                    <td><strong>Start time:</strong> {{ behavioral_event.0.start_time.hour }}:{{ behavioral_event.0.start_time.minute }}:{{ behavioral_event.0.start_time.second }}</td>
                                </tr>
                                <tr class="{% cycle 'even_row' 'odd_row' %}">
                                    <td><strong>Duration:</strong> {{ behavioral_event.0.duration.hour }}:{{ behavioral_event.0.duration.minute }}:{{ behavioral_event.0.duration.second }}</td>
                                </tr>
                            {% endif %}
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Primates:</strong> <div id="behavioral_event-{{ forloop.counter }}-primates">{% for primate in behavioral_event.0.primates.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ primate }}{% endfor %}</div></td>
                            </tr>
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Contexts:</strong> <div id="behavioral_event-{{ forloop.counter }}-contexts">{% for context in behavioral_event.0.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</div></td>
                            </tr>
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Ethograms:</strong> <div id="behavioral_event-{{ forloop.counter }}-ethograms">{% for ethogram in behavioral_event.0.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</div></td>
                            </tr>
                        </table>
                        {% if user == object.collator or has_edit_perms %}
                            <input type="button" value="Edit" onclick="return editBehavioralEvent({{behavioral_event.0.id}},{{ forloop.counter }});"/>&nbsp;
                        {% endif %}
                        {% if user == object.collator or has_delete_perms %}
                            <input type="button" value="Delete" onclick="deleteBehavioralEvent({{behavioral_event.0.id}},{{ forloop.counter }})"/>&nbsp;
                        {% endif %}
                        <h4>Behavioral and Gestural Sub-Events{% if user == object.collator %} <a href="#" onclick="return createBehavioralSubEvent({{ behavioral_event.0.id }},{{ forloop.counter }});">Add new</a>{% endif %}</h4>
                        <div id="sub_behavioral_events_list-{{ forloop.counter }}" class="sub_behavioral_events_list">
                            {% for sub_behavioral_event in behavioral_event.1 %}
                                <div id="sub_behavioral_event-{{ forloop.parentloop.counter }}.{{ forloop.counter }}" name="sub_behavioral_event">
                                    <div id="sub_behavioral_event-{{ forloop.parentloop.counter }}.{{ forloop.counter }}-start_time_seconds" class="sub_behavioral_event-start_time_seconds" style="display: none;">{{ sub_behavioral_event.start_time_seconds }}</div>
                                    <table class="_sub_tab_panel">
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td width=30%><strong><a href="" onclick="return setClipTime({{ sub_behavioral_event.start_time_seconds }});">Subevent {{ forloop.parentloop.counter }}.{{ forloop.counter }}</a></strong></td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td>
                                                    <a href="" onclick="return playClip({{ sub_behavioral_event.start_time_seconds }},{{ sub_behavioral_event.end_time_seconds }});">Play clip</a>
                                            </td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td><strong>Type:</strong> {{ sub_behavioral_event.type }}</td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td><strong>Start time:</strong> {{ sub_behavioral_event.start_time.hour }}:{{ sub_behavioral_event.start_time.minute }}:{{ sub_behavioral_event.start_time.second }}.{{ sub_behavioral_event.start_time.microsecond }}</td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td><strong>Relative to:</strong> {{ sub_behavioral_event.relative_to }}</td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td><strong>Duration:</strong> {{ sub_behavioral_event.duration.hour }}:{{ sub_behavioral_event.duration.minute }}:{{ sub_behavioral_event.duration.second }}.{{ sub_behavioral_event.duration.microsecond }}</td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td><strong>Primates:</strong> {% for primate in sub_behavioral_event.primates.all %}{% if forloop.counter0 > 0%}, {% endif %}<a href="/gbdb/primate/{{ primate.id }}/">{{ primate }}</a>{% endfor %}</td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td><strong>Contexts:</strong> {% for context in sub_behavioral_event.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                                        </tr>
                                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                                            <td><strong>Ethograms:</strong> {% for ethogram in sub_behavioral_event.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                                        </tr>
                                        {% if sub_behavioral_event.type == 'gestural' %}
                                            <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                                <td><strong>Signaller</strong> <a href="/gbdb/primate/{{ sub_behavioral_event.signaller.id }}/">{{ sub_behavioral_event.signaller }}</a></td>
                                            </tr>
                                            <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                                <td><strong>Recipient</strong> <a href="/gbdb/primate/{{ sub_behavioral_event.recipient.id }}/">{{ sub_behavioral_event.recipient }}</a></td>
                                            </tr>
                                            <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                                <td><strong>Gesture</strong> <a href="/gbdb/gesture/{{ sub_behavioral_event.gesture.id }}/">{{ sub_behavioral_event.gesture }}</a></td>
                                            </tr>
                                            <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                                <td><strong>Recipient response</strong> {{ sub_behavioral_event.recipient_response }}</td>
                                            </tr>
                                            <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                                <td><strong>Goal met</strong> {{ sub_behavioral_event.goal_met }}</td>
                                            </tr>
                                        {% endif %}
                                    </table>
                                    {% if user == object.collator or has_edit_perms %}
                                        <input type="button" value="Edit" onclick="return editBehavioralSubEvent({{ sub_behavioral_event.id}},{{ forloop.counter }},{{ forloop.parentloop.counter }});"/>&nbsp;
                                    {% endif %}
                                    {% if user == object.collator or has_delete_perms %}
                                        <input type="button" value="Delete" onclick="deleteBehavioralSubEvent({{ sub_behavioral_event.id}},{{ forloop.counter }},{{ forloop.parentloop.counter }})"/>&nbsp;
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>

        </div>
    
        <div class='video_panel'>
            {% if object.video.name or behavioral_events.0.0.video.name %}
                <div id='video_frame'>
                    <video id="observation_session_video" class="video-js vjs-default-skin" controls preload="auto"
                           width="600" height="400" data-setup='{}'>
                           {% if object.video.name %}
                               <source id="observation_session_video_source" src="{{ object.video_url_mp4 }}" type="video/mp4">
                           {% else %}
                               <source id="observation_session_video_source" src="{{ behavioral_events.0.0.video_url_mp4 }}" type="video/mp4">
                           {% endif %}
                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                    </video>
                    <div id="observation_session_timeline"></div>
                </div>
            {% else %}
                <div id='video_frame' style="display:none;">
                    <video id="observation_session_video" class="video-js vjs-default-skin" controls preload="auto"
                           width="600" height="400" data-setup='{}'>
                        <source id="observation_session_video_source" src="" type="video/mp4">
                        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
                    </video>
                    <div id="observation_session_timeline"></div>
                </div>
            {% endif %}
            <div id="context_data"></div>
        </div>
    
    </div>
                
    <script type="text/html" id="behavioral_event-template">
        <div id="behavioral_event-<%= idx %>" name="behavioral_event">
            <div id="behavioral_event-<%= idx %>-start_time_seconds" class="behavioral_event-start_time_seconds" style="display: none;"><%= start_time_seconds %></div>
            <table class="tab_panel">
                <tr class="<%= getTRTag(idx-1) %>">
                	{% if object.video.name %}
                    <td width=30%><strong><a href="" onclick="return setClipTime(<%= start_time_seconds %>)">Behavioral Event <%= idx %></a></strong></td>
                	{% else %}
                	<td width=30%><strong><a href="" onclick="return changeVideoSource('<%= video_url_mp4 %>')">Behavioral Event <%= idx %></a></strong></td>
                	{% endif %}
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td>
                    {% if object.video.name %}
                        <a href="" onclick="return playClip(<%= start_time_seconds %>,<%= end_time_seconds %>);">Play clip</a>
                    {% else %}
                        <a href="" onclick="return playClip(0);">Play clip</a>
                    {% endif %}
                    </td>
                </tr>
                <% if(start_time.length>0) { %>
                    <tr class="<%= getTRTag(idx-1) %>">
                        <td><strong>Start time:</strong> <%= start_time %></td>
                    </tr>
                    <tr class="<%= getTRTag(idx-1) %>">
                        <td><strong>Duration:</strong> <%= duration %></td>
                    </tr>
                <% } %>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Primates:</strong> <div id="behavioral_event-<%= idx %>-primates"><%= primates %></div></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Contexts:</strong> <div id="behavioral_event-<%= idx %>-contexts"><%= contexts %></div></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Ethograms:</strong> <div id="behavioral_event-<%= idx %>-ethograms"><%= ethograms %></div></td>
                </tr>
            </table>
            {% if user == object.collator or has_edit_perms %}
                <input type="button" value="Edit" onclick="return editBehavioralEvent(<%= id %>,<%= idx %>);"/>&nbsp;
            {% endif %}
            {% if user == object.collator or has_delete_perms %}
                <input type="button" value="Delete" onclick="deleteBehavioralEvent(<%= id %>,<%= idx %>)"/>&nbsp;
            {% endif %}
            <h4>Behavioral and Gestural Sub-Events{% if user == object.collator %} <a href="#" onclick="return createBehavioralSubEvent(<%= id %>, <%= idx %>);">Add new</a>{% endif %}</h4>
            <div id="sub_behavioral_events_list-<%= idx %>" class="sub_behavioral_events_list">
            </div>
        </div>
    </script>

    <script type="text/html" id="behavioral_subevent-template">
        <div id="sub_behavioral_event-<%= parentIdx %>.<%= idx %>" name="sub_behavioral_event">
            <div id="sub_behavioral_event-<%= parentIdx %>.<%= idx %>-start_time_seconds" class="sub_behavioral_event-start_time_seconds" style="display: none;"><%= start_time_seconds %></div>
            <table class="tab_panel">
                <tr class="<%= getTRTag(idx-1) %>">
                    <td width=30%><strong><a href="" onclick="return setClipTime(<%= start_time_seconds %>);">Subevent <%= parentIdx %>.<%= idx %></a></strong></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td>
                        <a href="" onclick="return playClip(<%= start_time_seconds %>,<%= end_time_seconds %>);">Play clip</a>
                    </td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Type:</strong> <%= type %></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Start time:</strong> <%= start_time %></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Relative to:</strong> <%= relative_to %></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Duration:</strong> <%= duration %></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Primates:</strong> <%= primates %></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Contexts:</strong> <%= contexts %></td>
                </tr>
                <tr class="<%= getTRTag(idx-1) %>">
                    <td><strong>Ethograms:</strong> <%= ethograms %></td>
                </tr>
                <% if(type == 'gestural') { %>
                    <tr class="<%= getTRTag(idx-1) %>">
                        <td><strong>Signaller</strong> <a href="/gbdb/primate/<%= signaller_id %>/"><%= signaller %></a></td>
                    </tr>
                    <tr class="<%= getTRTag(idx-1) %>">
                        <td><strong>Recipient</strong> <a href="/gbdb/primate/<%= recipient_id %>/"><%= recipient %></a></td>
                    </tr>
                    <tr class="<%= getTRTag(idx-1) %>">
                        <td><strong>Gesture</strong> <a href="/gbdb/gesture/<%= gesture_id %>/"><%= gesture %></a></td>
                    </tr>
                    <tr class="<%= getTRTag(idx-1) %>">
                        <td><strong>Recipient response</strong> <%= recipient_response %></td>
                    </tr>
                    <tr class="<%= getTRTag(idx-1) %>">
                        <td><strong>Goal met</strong> <%= goal_met %></td>
                    </tr>
                <% } %>
            </table>
            {% if user == object.collator or has_edit_perms %}
                <input type="button" value="Edit" onclick="return editBehavioralSubEvent(<%= id %>,<%= idx %>,<%= parentIdx %>);"/>&nbsp;
            {% endif %}
            {% if user == object.collator or has_delete_perms %}
                <input type="button" value="Delete" onclick="deleteBehavioralSubEvent(<%= id %>,<%= idx %>,<%= parentIdx %>)"/>&nbsp;
            {% endif %}
        </div>
    </script>
{% comment %}
{% load timeline %}
{% timeline %}  
{% endcomment %}
{% endblock %}
