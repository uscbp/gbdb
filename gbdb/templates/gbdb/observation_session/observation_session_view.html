{% extends "base_generic.html" %}
{% load staticfiles %}
{% block extrahead %}
    <title>GBDB - View Observation Session</title>
    <link href="{% static 'gbdb/scripts/video-js/video-js.css' %}" rel="stylesheet">
    <script src="{% static 'gbdb/scripts/video-js/video.js' %}"></script>
    <script src="{% static 'gbdb/scripts/video-js/video-framebyframe.js' %}"></script>
    <script src="{% static 'gbdb/scripts/timeline.js' %}"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
    <script type="text/javascript">
        function deleteObservationSession()
        {
            if(confirm('This will delete this Observation Session as well as all links to it from other entries. Do you really want to delete the current Observation Session?'))
            {
                var data={'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={type:"POST", url:"/gbdb/observation_session/{{ object.id }}/delete/", data: data, complete: doneDelete };
                $.ajax(args);
            }
        }

        function doneDelete()
        {
            document.location.href='/gbdb/';
        }

        function initialize() {
            var map = new google.maps.Map(
                    document.getElementById('map-canvas'), {
                        center: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                        zoom: 13,
                        mapTypeId: google.maps.MapTypeId.HYBRID
                    });

            var marker = new google.maps.Marker({
                position: new google.maps.LatLng({{ object.location.latitude }}, {{ object.location.longitude }}),
                map: map,
                title: '{{ object.location_name }}'
            });
        }
        google.maps.event.addDomListener(window, 'load', initialize);

        function playClip(start_time, end_time)
        {
            videojs("observation_session_video").currentTime(start_time);
            function stopClip(){
                if(this.currentTime()>=end_time)
                {
                    this.pause();
                    this.off('timeupdate',stopClip);
                }
            }
            videojs("observation_session_video").on("timeupdate",stopClip);
            videojs("observation_session_video").play();
            return false;
        };
        
        function playClip(start_time)
        {
            videojs("observation_session_video").currentTime(start_time);
            videojs("observation_session_video").play();
            return false;
        };
        
        function setClipTime(start_time)
        {
        	videojs("observation_session_video").currentTime(start_time);
        	return false;
        };
        
        function displayEdit(href)
        {
        	$('#context_data').load(href);
        };
        
        function addPeriod(time_in, time_out, track, label, content)
        {
        	var id = timeline.addPeriod(time_in, time_out,'#'+Math.floor(Math.random()*16777215).toString(16), track, label);
        };
        
        function drawTimeline()
        {       
        	
        	$('#observation_session_timeline').html("");
        	var options = {
                        'height':100,
                        'width':videojs("observation_session_video").width(),
                        'numberOfTracks':2,
                        'cursorHeight':30,
                        'periodShape':'bubble',
                        'scaleHeight':30,
                        'scaleBackgroundColor':'#000',
                        'backgroundColor':'#EAE5E1',
                        'scaleColor':'#EAE5E1',
                        'trackSeparatorColor':'#EAE5E1',
                        'textColor':'#EAE5E1',
                        'cursorColor':'#f00',
                        'scaleFactor':2,
                        };

            timeline = new Timeline('observation_session_video', 'observation_session_timeline', videojs("observation_session_video").duration(), options);
            for(var i = 0; i<periods.length; i++){
                id = timeline.addPeriod(periods[i]['data'].start_time_seconds,periods[i]['data'].end_time_seconds, '#'+Math.floor(Math.random()*16777215).toString(16), periods[i]['data'].track, periods[i]['data'].label);
            }
        };

        $(document).ready(function()
        {
        	periods = [];
        	drawTimeline();
            videojs.options.flash.swf = "{{ site_url }}/static/gbdb/scripts/video-js/video-js.swf";
           
                videojs('observation_session_video', {
                    plugins: {
                        framebyframe: {
                            fps: 30,
                            steps: [
                                { text: '-5', step: -5 },
                                { text: '-1', step: -1 },
                                { text: '+1', step: 1 },
                                { text: '+5', step: 5 },
                            ]
                        }
                    }
                });
				
				{% for behavioral_event in behavioral_events %}
					var count = '{{ forloop.counter }}';
					var period =  {id:'{{behavioral_event.id}}', data: {id:'{{behavioral_event.id}}', idx: count, label: count.toString(), start_time: '{{behavioral_event.0.start_time}}',
                        duration: '{{behavioral_event.0.duration}}', start_time_seconds: '{{behavioral_event.0.start_time_seconds}}',
                        end_time_seconds: '{{behavioral_event.0.end_time_seconds}}', video: '{{behavioral_event.0.video}}', video_url_mp4: '{{behavioral_event.0.video_url_mp4}}', 
                        notes: '{{behavioral_event.0.notes}}', primates: '{{behavioral_event.0.primates}}', contexts: '{{behavioral_event.0.contexts}}', ethograms: '{{behavioral_event.0.ethograms}}', track: 2}};
				
	                // var period = {time_in:'{{behavioral_event.0.start_time_seconds}}',
	                    // time_out:'{{behavioral_event.0.end_time_seconds}}',
	                    // track:2,
	                    // color:'#'+Math.floor(Math.random()*16777215).toString(16),
	                    // label:'{{ forloop.counter }}',
	                    // content: '{{behavioral_event.0.notes|linebreaks}}'};
	                 periods.push(period);
	                {% for child in behavioral_event.1 %}
	                var sub_count = '{{ forloop.counter }}';
	                period = {id:'{{child.id}}', data: {parentIdx: count, idx: sub_count++, label: count.toString() + '.' + sub_count.toString(), start_time_seconds: '{{child.start_time_seconds}}',
                            end_time_seconds: '{{child.end_time_seconds}}', type: '{{child.type}}',
                            start_time: '{{child.start_time}}', relative_to: '{{child.relative_to}}',
                            duration: '{{child.duration}}', primates: '{{child.primates}}',
                            contexts: '{{child.contexts}}', ethograms: '{{child.ethograms}}',
                            signaller_id: '{{child.signaller_id}}', signaller:'{{child.signaller}}',
                            recipient_id: '{{child.recipient_id}}', recipient: '{{child.recipient}}',
                            gesture_id: '{{child.gesture_id}}', gesture:'{{child.gesture}}',
                            recipient_response: '{{child.recipient_reponse}}',
                            goal_met: '{{child.goal_met}}', notes: '{{child.notes}}', track: 1}
                       };
	                // var period = {time_in:'{{child.start_time_seconds}}',
	                    // time_out:'{{child.end_time_seconds}}',
	                    // track:1,
	                    // color:'#'+Math.floor(Math.random()*16777215).toString(16),
	                    // label:'{{ forloop.parentloop.counter }}.{{ forloop.counter }}',
	                    // content: '{{child.notes|linebreaks}}'};
	                periods.push(period);
	                {% endfor %}
	            {% endfor %}
            
                videojs("observation_session_video").on("loadedmetadata", function(){
                	drawTimeline();
                });

                videojs("observation_session_video").on("timeupdate", function(){
                    var time = videojs("observation_session_video").currentTime();
                    var active_data = [];
                    for(var i=0; i<periods.length; i++){
                        if(time >= periods[i]['data'].start_time_seconds && time < periods[i]['data'].end_time_seconds){
                            active_data.push("<strong>Event " + periods[i]['data'].label + " Notes: </strong>" +periods[i]['data'].notes);
                        }
                    };
                    $('#context_data').html(active_data.join('<br /><br />'));
                });
            
        });

        behavioralEventEditIdx=-1;
        function editBehavioralEvent(id, idx)
        {
            $('#context_data').load('/gbdb/behavioral_event/'+id+'/edit/');
            behavioralEventEditIdx=idx;
            return false;
        }

        function createBehavioralEvent()
        {
            $('#context_data').load('/gbdb/behavioral_event/new/?observation_session={{ object.id }}');
            behavioralEventEditIdx=-1;
            return false;
        }

        function submitBehavioralEventForm(url, obs_id)
        {
            document.getElementById('savingMsg').style.display = 'block';
            document.getElementById('savingOver').style.display = 'block';
            var frm = $('#behavioralEventForm');
            var data = new FormData(frm.get(0));
	        $.ajax({
	            url: url,
    			type: frm.attr('method'),
	            data: data,
	            success: doneSubmitBehavioralEventForm,
	            processData: false,
	            contentType: false,
	        });
        }
        
        function changeVideoSource(source){
        	document.getElementById('observation_session_video_source').src = source;
        	videojs("observation_session_video").load();
        	return false;
        }

        function doneSubmitBehavioralEventForm(data, status){
            if (status=="success")
            {
                /*var tmplMarkup = $('#behavioral_event-template').html();
                if(behavioralEventEditIdx<0)
                {
                    var count = $('#behavioral_events').children("[id^=behavioral_event]").length;
                    var period = { id: data.id, data: {id: data.id, idx : count+1, label: (count+1).toString(), start_time: data.start_time,
                        duration: data.duration, start_time_seconds: data.start_time_seconds,
                        end_time_seconds: data.end_time_seconds, video: data.video, video_url_mp4: data.video_url_mp4, notes: data.notes,
                        primates: data.primates, contexts: data.contexts, ethograms: data.ethograms, track: 2}};
                    var compiledTmpl = _.template(tmplMarkup, period['data']);
                    periods.push(period);
                    $('#behavioral_events').append(compiledTmpl);
                    var tmplMarkup = $('#behavioral_subevent-template').html();
                    for(var i=0; i<data.subevents.length; i++)
                    {
                    	period = { id: data.subevents[i]['id'], data:{parentIdx: count+1, idx: i+1, label: (count+1).toString() + '.' + (i+1).toString(),
                            start_time_seconds: data.subevents[i]['start_time_seconds'],
                            end_time_seconds: data.subevents[i]['end_time_seconds'],
                            type: data.subevents[i]['type'], start_time: data.subevents[i]['start_time'],
                            relative_to: data.subevents[i]['relative_to'], duration: data.subevents[i]['duration'],
                            primates: data.subevents[i]['primates'], contexts: data.subevents[i]['contexts'],
                            ethograms: data.subevents[i]['ethograms'], signaller_id: data.subevents[i]['signaller_id'],
                            signaller: data.subevents[i]['signaller'], recipient_id: data.subevents[i]['recipient_id'],
                            recipient: data.subevents[i]['recipient'], gesture_id: data.subevents[i]['gesture_id'],
                            gesture: data.subevents[i]['gesture'],
                            recipient_response: data.subevents[i]['recipient_response'],
                            goal_met: data.subevents[i]['goal_met'], notes: data.subevents[i]['notes'], track: 1}
                       };
                       periods.push(period);
                        var compiledTmpl = _.template(tmplMarkup, period['data']);
                        $('#sub_behavioral_events_list-'+ (count+1)).append(compiledTmpl);
                    }
                    {% if not object.video.name %}
                        document.getElementById('observation_session_video_source').src = data.video_url_mp4;
                        $("#video_frame").css("display", "block");
                        videojs("observation_session_video").load();
                    {% else %}
                    	drawTimeline();
                    {% endif %}
                }
                else
                {
                	var period = { id: data.id, data: {id: data.id, idx : behavioralEventEditIdx, label: behavioralEventEditIdx.toString(), start_time: data.start_time,
                        duration: data.duration, start_time_seconds: data.start_time_seconds,
                        end_time_seconds: data.end_time_seconds, video: data.video, video_url_mp4: data.video_url_mp4, notes: data.notes,
                        primates: data.primates, contexts: data.contexts, ethograms: data.ethograms, track: 2}};
                    var compiledTmpl = _.template(tmplMarkup, period['data']);
                    $('#behavioral_event-'+behavioralEventEditIdx).replaceWith(compiledTmpl);
                    $('#sub_behavioral_events_list-'+behavioralEventEditIdx).empty();
                    var tmplMarkup = $('#behavioral_subevent-template').html();
                    for(var i=0; i<data.subevents.length; i++)
                    {
                    	period = { id: data.subevents[i]['id'], data:{parentIdx: behavioralEventEditIdx, idx: i+1, label: behavioralEventEditIdx.toString() + '.' + (i+1).toString(),
                            start_time_seconds: data.subevents[i]['start_time_seconds'],
                            end_time_seconds: data.subevents[i]['end_time_seconds'],
                            type: data.subevents[i]['type'], start_time: data.subevents[i]['start_time'],
                            relative_to: data.subevents[i]['relative_to'], duration: data.subevents[i]['duration'],
                            primates: data.subevents[i]['primates'], contexts: data.subevents[i]['contexts'],
                            ethograms: data.subevents[i]['ethograms'], signaller_id: data.subevents[i]['signaller_id'],
                            signaller: data.subevents[i]['signaller'], recipient_id: data.subevents[i]['recipient_id'],
                            recipient: data.subevents[i]['recipient'], gesture_id: data.subevents[i]['gesture_id'],
                            gesture: data.subevents[i]['gesture'],
                            recipient_response: data.subevents[i]['recipient_response'],
                            goal_met: data.subevents[i]['goal_met'], notes: data.subevents[i]['notes'], track: 1}
                       };
                        var compiledTmpl = _.template(tmplMarkup, period['data']);
                        $('#sub_behavioral_events_list-'+behavioralEventEditIdx).append(compiledTmpl);
                    }
                    behavioralEventEditIdx=-1;
                    {% if not object.video.name %}
                        document.getElementById('observation_session_video_source').src = data.video_url_mp4;
                        $("#video_frame").css("display", "block");
                        videojs("observation_session_video").load();
                    {% else %}
                    	drawTimeline();
                    {% endif %}

                }*/
                $('#context_data').empty();
                document.location.reload();
            }
            document.getElementById('savingMsg').style.display = 'none';
            document.getElementById('savingOver').style.display = 'none';
        }

        function deleteBehavioralEvent(id, idx)
        {
            if(confirm('This will delete this Behavioral Event as well as all links to it from other entries. Do you really want to delete the current Behavioral Event?'))
            {
                var data={'idx':idx, 'csrfmiddlewaretoken': '{{ csrf_token }}'};
                var args={type:"POST", url:'/gbdb/behavioral_event/'+id+'/delete/', data: data, success: doneBehavioralEventDelete };
                $.ajax(args);
            }
        }

        function doneBehavioralEventDelete(data, status)
        {
            if(status=='success')
            {
                /*$('#behavioral_event-'+data.idx).remove();
                var count = $('#behavioral_events').children("[id^=behavioral_event]").length;
                if(count == 0){
                	document.getElementById('observation_session_video_source').src = "";
                    $("#video_frame").css("display", "none");
                }
                $('#context_data').empty();
                */
                document.location.reload();
            }
        }

        function submitObservationSessionForm(url, obs_id)
        {
            document.getElementById('savingMsg').style.display = 'block';
            document.getElementById('savingOver').style.display = 'block';
            var frm = $('#observationSessionForm');
            var data = new FormData(frm.get(0));
            $.ajax({
                url: url,
                type: frm.attr('method'),
                data: data,
                success: doneSubmitObservationSession,
                processData: false,
                contentType: false
            });
        }

        function doneSubmitObservationSession(data, status){
            document.getElementById('savingMsg').style.display = 'none';
            document.getElementById('savingOver').style.display = 'none';
            if(status=='success')
            {
                //document.location.href='/gbdb/observation_session/'.concat(data.id.toString(), '/');
                document.location.reload();
            }
        }

    </script>
{% endblock %}
{% block content %}
    <div id="detail">
    	<div class="info_panel">
        <h2>Observation Session</h2>
        <table class="tab_panel">
            <tr valign="top">
                <td><strong>Collator:</strong> {{ object.get_collator_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Created:</strong> {{ object.get_created_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Last modified by:</strong> {{ object.get_modified_by_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Last modified:</strong> {{ object.get_modified_str }}</td>
            </tr>
            <tr valign="top">
                <td><strong>Date:</strong> {{ object.date }}</td>
            <tr valign="top">
                <td><strong>Location: </strong> {{ object.location_name }}</td></td>
            </tr>
            <tr valign="top">
                <td>
                    <div id="map-canvas" style="height:200px"></div>
                </td>
            </tr>
        </table>
        {% if user == object.collator %}
            <input type="button" value="Edit" onclick="displayEdit('/gbdb/observation_session/{{object.id}}/edit/')"/>&nbsp;
            <input type="button" value="Delete" onclick="deleteObservationSession()"/>&nbsp;
        {% endif %}

        <br>
        <h3>Behavioral Events{% if user == object.collator %} <a href="#" onclick="return createBehavioralEvent();">Add new</a>{% endif %}</h3>
        <div id="behavioral_events">
            {% for behavioral_event in behavioral_events %}
                <div id="behavioral_event-{{ forloop.counter }}" name="behavioral_event">
                    <table class="tab_panel">
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                        	{% if not behavioral_event.0.video.name %}
                            <td width=30%><strong><a href="" onclick="return setClipTime({{ behavioral_event.0.start_time_seconds }})">Behavioral Event {{ forloop.counter }}</a></strong></td>
                        	{% else %}
                        	<td width=30%><strong><a href="" onclick="return changeVideoSource('{{ behavioral_event.0.video_url_mp4 }}')">Behavioral Event {{ forloop.counter }}</a></strong></td>
                        	{% endif %}
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                        	<td>
                                {% if not behavioral_event.0.video.name %}
                                    <a href="" onclick="return playClip({{ behavioral_event.0.start_time_seconds }},{{ behavioral_event.0.end_time_seconds }});">Play clip</a>
                                {% else %}
                               		<a href="" onclick="return playClip(0);">Play clip</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% if not behavioral_event.0.video.name %}
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Start time:</strong> {{ behavioral_event.0.start_time.hour }}:{{ behavioral_event.0.start_time.minute }}:{{ behavioral_event.0.start_time.second }}</td>
                            </tr>
                            <tr class="{% cycle 'even_row' 'odd_row' %}">
                                <td><strong>Duration:</strong> {{ behavioral_event.0.duration.hour }}:{{ behavioral_event.0.duration.minute }}:{{ behavioral_event.0.duration.second }}</td>
                            </tr>
                        {% endif %}
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Primates:</strong> {% for primate in behavioral_event.0.primates.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ primate }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Contexts:</strong> {% for context in behavioral_event.0.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                        </tr>
                        <tr class="{% cycle 'even_row' 'odd_row' %}">
                            <td><strong>Ethograms:</strong> {% for ethogram in behavioral_event.0.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                        </tr>
                    </table>
                    {% if user == object.collator %}
			        <input type="button" value="Edit" onclick="return editBehavioralEvent({{behavioral_event.0.id}},{{ forloop.counter }});"/>&nbsp;
			        <input type="button" value="Delete" onclick="deleteBehavioralEvent({{behavioral_event.0.id}},{{ forloop.counter }})"/>&nbsp;
			        {% endif %}
                    <h4>Behavioral and Gestural Sub-Events</h4>
                    <div id="sub_behavioral_events_list-{{ forloop.counter }}" class="sub_behavioral_events_list">
                        {% for sub_behavioral_event in behavioral_event.1 %}
                            <div id="sub_behavioral_event-{{ forloop.parentloop.counter }}.{{ forloop.counter }}" name="sub_behavioral_event">
                                <table class="tab_panel">
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td width=30%><strong><a href="" onclick="return setClipTime({{ sub_behavioral_event.start_time_seconds }});"> Subevent {{ forloop.parentloop.counter }}.{{ forloop.counter }}</a></strong></td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td>
                                                <a href="" onclick="return playClip({{ sub_behavioral_event.start_time_seconds }},{{ sub_behavioral_event.end_time_seconds }});">Play clip</a>
                                        </td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td><strong>Type:</strong> {{ sub_behavioral_event.type }}</td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td><strong>Start time:</strong> {{ sub_behavioral_event.start_time.hour }}:{{ sub_behavioral_event.start_time.minute }}:{{ sub_behavioral_event.start_time.second }}.{{ sub_behavioral_event.start_time.microsecond }}</td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td><strong>Relative to:</strong> {{ sub_behavioral_event.relative_to }}</td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td><strong>Duration:</strong> {{ sub_behavioral_event.duration.hour }}:{{ sub_behavioral_event.duration.minute }}:{{ sub_behavioral_event.duration.second }}.{{ sub_behavioral_event.duration.microsecond }}</td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td><strong>Primates:</strong> {% for primate in sub_behavioral_event.primates.all %}{% if forloop.counter0 > 0%}, {% endif %}<a href="/gbdb/primate/{{ primate.id }}/">{{ primate }}</a>{% endfor %}</td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td><strong>Contexts:</strong> {% for context in sub_behavioral_event.contexts.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ context.name }}{% endfor %}</td>
                                    </tr>
                                    <tr class="{% cycle 'even_row' 'odd_row' %}">
                                        <td><strong>Ethograms:</strong> {% for ethogram in sub_behavioral_event.ethograms.all %}{% if forloop.counter0 > 0 %}, {% endif %}{{ ethogram.name }}{% endfor %}</td>
                                    </tr>
                                    {% if sub_behavioral_event.type == 'gestural' %}
                                        <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                            <td><strong>Signaller</strong> <a href="/gbdb/primate/{{ sub_behavioral_event.signaller.id }}/">{{ sub_behavioral_event.signaller }}</a></td>
                                        </tr>
                                        <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                            <td><strong>Recipient</strong> <a href="/gbdb/primate/{{ sub_behavioral_event.recipient.id }}/">{{ sub_behavioral_event.recipient }}</a></td>
                                        </tr>
                                        <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                            <td><strong>Gesture</strong> <a href="/gbdb/gesture/{{ sub_behavioral_event.gesture.id }}/">{{ sub_behavioral_event.gesture }}</a></td>
                                        </tr>
                                        <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                            <td><strong>Recipient response</strong> {{ sub_behavioral_event.recipient_response }}</td>
                                        </tr>
                                        <tr class="{% if forloop.counter0|divisibleby:2 %}even_row{% else %}odd_row{% endif %}">
                                            <td><strong>Goal met</strong> {{ sub_behavioral_event.goal_met }}</td>
                                        </tr>
                                    {% endif %}
                                </table>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

    </div>
    
    <div id='video_panel'>
		{% if object.video.name or behavioral_events.0.0.video.name%}
		<div id='video_frame'>
		    <video id="observation_session_video" class="video-js vjs-default-skin" controls preload="auto"
		           width="600" height="400" data-setup='{}'>
		           {% if object.video.name %}
		        <source id="observation_session_video_source" src="{{ object.video_url_mp4 }}" type="video/mp4">
		        	{% else %}
		        	<source id="observation_session_video_source" src="{{ behavioral_events.0.0.video_url_mp4 }}" type="video/mp4">
		        	{% endif %}
		        <p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
		    </video>
		    <div id="observation_session_timeline"></div>
		</div>
		{% else %}
		<div id='video_frame' style="display:none;">
		 <video id="observation_session_video" class="video-js vjs-default-skin" controls preload="auto"
		           width="600" height="400" data-setup='{}'>
		          <source id="observation_session_video_source" src="" type="video/mp4">
		          	<p class="vjs-no-js">To view this video please enable JavaScript, and consider upgrading to a web browser that <a href="http://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a></p>
		    </video>
		    <div id="observation_session_timeline"></div>
		</div>
		{% endif %}
		<div id="context_data"></div>
    </div>
    
    </div>
                
    <script type="text/html" id="behavioral_event-template">
        <div id="behavioral_event-<%= idx %>" name="behavioral_event">
            <table class="tab_panel">
                <tr class="<%= getTRTag(idx) %>">
                	{% if object.video.name %}
                    <td width=30%><strong><a href="" onclick="return setClipTime(<%= start_time_seconds %>)">Behavioral Event <%= idx %></a></strong></td>
                	{% else %}
                	<td width=30%><strong><a href="" onclick="return changeVideoSource('<%= video_url_mp4 %>')">Behavioral Event <%= idx %></a></strong></td>
                	{% endif %}
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td>
                    {% if object.video.name %}
                        <a href="" onclick="return playClip(<%= start_time_seconds %>,<%= end_time_seconds %>);">Play clip</a>
                    {% else %}
                        <a href="" onclick="return playClip(0);">Play clip</a>
                    {% endif %}
                    </td>
                </tr>
                <% if(start_time.length>0) { %>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Start time:</strong> <%= start_time %></td>
                    </tr>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Duration:</strong> <%= duration %></td>
                    </tr>
                <% } %>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Primates:</strong> <%= primates %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Contexts:</strong> <%= contexts %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Ethograms:</strong> <%= ethograms %></td>
                </tr>
            </table>
            {% if user == object.collator %}
                <input type="button" value="Edit" onclick="return editBehavioralEvent(<%= id %>,<%= idx %>);"/>&nbsp;
                <input type="button" value="Delete" onclick="deleteBehavioralEvent(<%= id %>,<%= idx %>)"/>&nbsp;
            {% endif %}
            <h4>Behavioral and Gestural Sub-Events</h4>
            <div id="sub_behavioral_events_list-<%= idx %>" class="sub_behavioral_events_list">
            </div>
        </div>
    </script>

    <script type="text/html" id="behavioral_subevent-template">
        <div id="sub_behavioral_event-<%= parentIdx %>.<%= idx %>" name="sub_behavioral_event">
            <table class="tab_panel">
                <tr class="<%= getTRTag(idx) %>">
                    <td width=30%><strong><a href="" onclick="return setClipTime(<%= start_time_seconds %>);">Behavioral Subevent <%= parentIdx %>.<%= idx %></a></strong></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td>
                            <a href="" onclick="return playClip(<%= start_time_seconds %>,<%= end_time_seconds %>);">Play clip</a>
                    </td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Type:</strong> <%= type %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Start time:</strong> <%= start_time %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Relative to:</strong> <%= relative_to %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Duration:</strong> <%= duration %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Primates:</strong> <%= primates %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Contexts:</strong> <%= contexts %></td>
                </tr>
                <tr class="<%= getTRTag(idx) %>">
                    <td><strong>Ethograms:</strong> <%= ethograms %></td>
                </tr>
                <% if(type == 'gestural') { %>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Signaller</strong> <a href="/gbdb/primate/<%= signaller_id %>/"><%= signaller %></a></td>
                    </tr>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Recipient</strong> <a href="/gbdb/primate/<%= recipient_id %>/"><%= recipient %></a></td>
                    </tr>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Gesture</strong> <a href="/gbdb/gesture/<%= gesture_id %>/"><%= gesture %></a></td>
                    </tr>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Recipient response</strong> <%= recipient_response %></td>
                    </tr>
                    <tr class="<%= getTRTag(idx) %>">
                        <td><strong>Goal met</strong> <%= goal_met %></td>
                    </tr>
                <% } %>
            </table>
        </div>
    </script>
{% comment %}
{% load timeline %}
{% timeline %}  
{% endcomment %}
{% endblock %}
